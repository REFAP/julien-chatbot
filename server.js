const express = require('express');
const cors = require('cors');
const path = require('path');
require('dotenv').config();

const app = express();
const port = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static('.'));

// Configuration des APIs
const CLAUDE_API_KEY = process.env.CLAUDE_API_KEY;

// ==================== BASE FAP EXPERTE SIMPLE ====================
const FAP_EXPERT_DATABASE = [
  {
    id: 'FAP001',
    triggers: ['voyant', 'moteur', 'puissance', 'perte'],
    symptoms: 'Voyant moteur + perte de puissance',
    question: "Avez-vous des codes d'erreur comme P2002, P2463, P244A ?",
    responses: {
      'P2002': {
        diagnosis: "üîß **Code P2002 - FAP colmat√©**\n\n**Cause :** Filtre √† particules satur√© en suie\n**Solution :** Nettoyage FAP professionnel ou r√©g√©n√©ration forc√©e",
        ctas: [
          { type: 'professional', text: 'üîß Nettoyage FAP Re-Fap', action: 'book_cleaning' },
          { type: 'self_service', text: 'üõ£Ô∏è Tentative r√©g√©n√©ration autoroute', action: 'highway_regen' }
        ]
      },
      'P2463': {
        diagnosis: "üö® **Code P2463 - Suie excessive**\n\n**Cause :** Accumulation critique de suie\n**Solution :** Intervention professionnelle URGENTE",
        ctas: [
          { type: 'emergency', text: 'üö® Intervention urgente', action: 'emergency_call' }
        ]
      },
      'aucun': {
        diagnosis: "üîç **Sans code d'erreur**\n\nQuel est votre type de conduite principalement ?",
        follow_up: 'driving_pattern'
      }
    }
  },
  {
    id: 'FAP002',
    triggers: ['fum√©e', 'noire', 'echappement'],
    symptoms: 'Fum√©e noire √† l\'√©chappement',
    diagnosis: "üîß **Fum√©e noire = FAP colmat√©**\n\n**Explication :** Combustion incompl√®te due au FAP satur√©\n**Action :** Nettoyage professionnel recommand√©",
    ctas: [
      { type: 'professional', text: 'üîß Diagnostic + Nettoyage FAP', action: 'book_service' }
    ]
  },
  {
    id: 'FAP003',
    triggers: ['urbain', 'ville', 'court', 'trajet'],
    symptoms: 'Conduite urbaine exclusive',
    diagnosis: "üö® **Conduite urbaine = Probl√®me FAP**\n\n**Pourquoi :** Le FAP a besoin de 600¬∞C pendant 20+ minutes pour se r√©g√©n√©rer. Impossible en ville !\n\n**Solution imm√©diate :** Trajet autoroute 30+ km √† 90+ km/h",
    ctas: [
      { type: 'education', text: 'üìö Guide r√©g√©n√©ration FAP', action: 'learn_regen' },
      { type: 'professional', text: 'üîß Nettoyage si √©chec', action: 'book_cleaning' }
    ]
  }
];

// Autres probl√®mes non-FAP
const OTHER_ISSUES_DB = [
  {
    id: 'TURBO001',
    triggers: ['turbo', 'siffle', 'sifflement'],
    diagnosis: "üîß **Turbo qui siffle**\n\nCause probable : Turbine us√©e ou fuite durite\nAction : Contr√¥le pression turbo",
    ctas: [{ type: 'diagnostic', text: 'üîç Diagnostic turbo', action: 'turbo_check' }]
  },
  {
    id: 'EGR001',
    triggers: ['egr', 'vanne', 'prechauffage'],
    diagnosis: "üîß **Probl√®me EGR/Pr√©chauffage**\n\nCause probable : Vanne EGR encrass√©e\nAction : Nettoyage vanne EGR",
    ctas: [{ type: 'service', text: 'üîß Service EGR', action: 'egr_service' }]
  }
];

// ==================== MOTEUR SIMPLE ET ROBUSTE ====================
class SimpleFAPExpert {
  constructor() {
    this.fapDB = FAP_EXPERT_DATABASE;
    this.otherDB = OTHER_ISSUES_DB;
  }

  async processMessage(userMessage, step = 'initial') {
    const messageLower = userMessage.toLowerCase();
    console.log(`üí¨ Analyse: "${userMessage}" (√©tape: ${step})`);

    // √âtape 1: D√©tection du probl√®me
    if (step === 'initial') {
      return this.detectIssueType(messageLower);
    }

    // √âtape 2: Questions de suivi FAP
    if (step === 'fap_followup') {
      return this.handleFAPFollowup(messageLower);
    }

    // √âtape 3: Pattern de conduite
    if (step === 'driving_pattern') {
      return this.analyzeDrivingPattern(messageLower);
    }

    // Fallback
    return this.handleUnknownIssue(userMessage);
  }

  detectIssueType(messageLower) {
    // Recherche FAP en priorit√©
    for (const fapCase of this.fapDB) {
      const matchCount = fapCase.triggers.filter(trigger => 
        messageLower.includes(trigger)
      ).length;

      if (matchCount >= 2) {
        console.log(`‚úÖ FAP d√©tect√©: ${fapCase.id} (${matchCount} triggers)`);
        
        if (fapCase.question) {
          return {
            message: `üîß **Probl√®me FAP d√©tect√© !**\n\n${fapCase.symptoms}\n\n${fapCase.question}`,
            source: 'fap_expert',
            nextStep: 'fap_followup',
            caseId: fapCase.id
          };
        } else {
          return {
            message: fapCase.diagnosis,
            source: 'fap_expert',
            ctas: fapCase.ctas || []
          };
        }
      }
    }

    // Recherche autres probl√®mes
    for (const issue of this.otherDB) {
      const hasMatch = issue.triggers.some(trigger => 
        messageLower.includes(trigger)
      );

      if (hasMatch) {
        console.log(`‚úÖ Autre probl√®me: ${issue.id}`);
        return {
          message: issue.diagnosis,
          source: 'expert_database',
          ctas: issue.ctas || []
        };
      }
    }

    // Pas de correspondance -> Questions g√©n√©rales
    return this.askGeneralQuestions();
  }

  handleFAPFollowup(messageLower) {
    // D√©tection codes d'erreur
    const errorCodes = messageLower.match(/P[0-9A-F]{4}/gi);
    
    if (errorCodes && errorCodes.length > 0) {
      const code = errorCodes[0].toUpperCase();
      const fapCase = this.fapDB.find(f => f.responses && f.responses[code]);
      
      if (fapCase && fapCase.responses[code]) {
        const response = fapCase.responses[code];
        return {
          message: response.diagnosis,
          source: 'fap_expert',
          ctas: response.ctas || [],
          confidence: 0.9
        };
      }
    }

    // Pas de code -> Analyser conduite
    if (messageLower.includes('aucun') || messageLower.includes('pas') || messageLower.includes('non')) {
      return {
        message: "D'accord, pas de code d'erreur. Quel est votre type de conduite ?\n\n‚Ä¢ Principalement en ville (trajets < 20 min)\n‚Ä¢ Mixte ville/route\n‚Ä¢ Principalement autoroute/longs trajets",
        source: 'fap_expert',
        nextStep: 'driving_pattern'
      };
    }

    return this.askGeneralQuestions();
  }

  analyzeDrivingPattern(messageLower) {
    if (messageLower.includes('ville') || messageLower.includes('urbain') || messageLower.includes('court')) {
      const urbanCase = this.fapDB.find(f => f.id === 'FAP003');
      return {
        message: urbanCase.diagnosis,
        source: 'fap_expert',
        ctas: urbanCase.ctas,
        confidence: 0.85
      };
    }

    if (messageLower.includes('mixte')) {
      return {
        message: "üîß **Conduite mixte**\n\nVotre FAP se r√©g√©n√®re parfois mais pas assez.\n\n**Recommandation :** Augmentez la fr√©quence des longs trajets (30+ km d'affil√©e)",
        source: 'fap_expert',
        ctas: [
          { type: 'education', text: 'üìö Guide conduite FAP', action: 'driving_guide' },
          { type: 'professional', text: 'üîß Nettoyage pr√©ventif', action: 'preventive_cleaning' }
        ]
      };
    }

    if (messageLower.includes('autoroute') || messageLower.includes('long')) {
      return {
        message: "ü§î **Conduite favorable au FAP**\n\nMalgr√© vos longs trajets, le probl√®me persiste.\n\n**Analyse :** Possible d√©faillance capteur ou FAP tr√®s encrass√©",
        source: 'fap_expert',
        ctas: [
          { type: 'professional', text: 'üîç Diagnostic approfondi', action: 'deep_diagnostic' }
        ]
      };
    }

    return this.askGeneralQuestions();
  }

  askGeneralQuestions() {
    return {
      message: "Pour mieux vous aider, pouvez-vous me dire :\n\n‚Ä¢ Quels voyants sont allum√©s ?\n‚Ä¢ Ressentez-vous une perte de puissance ?\n‚Ä¢ Y a-t-il de la fum√©e √† l'√©chappement ?\n‚Ä¢ Quel type de conduite faites-vous ?",
      source: 'fap_expert',
      nextStep: 'initial'
    };
  }

  async handleUnknownIssue(userMessage) {
    console.log('ü§ñ Fallback vers Claude...');
    
    const aiResponse = await this.getClaudeResponse(userMessage);
    
    return {
      message: aiResponse || "Je ne peux pas analyser ce probl√®me sp√©cifique. Pour les probl√®mes de FAP, d√©crivez-moi vos sympt√¥mes (voyants, perte de puissance, fum√©e, etc.)",
      source: 'AI',
      ctas: [
        { type: 'contact', text: 'üìû Parler √† un expert', action: 'contact_expert' }
      ]
    };
  }

  async getClaudeResponse(message) {
    if (!CLAUDE_API_KEY) return null;
    
    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'x-api-key': CLAUDE_API_KEY,
          'Content-Type': 'application/json',
          'anthropic-version': '2023-06-01'
        },
        body: JSON.stringify({
          model: 'claude-3-sonnet-20240229',
          max_tokens: 300,
          messages: [{
            role: 'user',
            content: `Tu es Julien, expert FAP Re-Fap. R√©ponds bri√®vement √† cette question automobile: ${message}`
          }]
        })
      });

      const data = await response.json();
      return data.content?.[0]?.text;
    } catch (error) {
      console.error('‚ùå Erreur Claude:', error);
      return null;
    }
  }
}

// ==================== ROUTES SIMPLES ====================
const fapExpert = new SimpleFAPExpert();

// Sessions simples en m√©moire
const sessions = new Map();

app.post('/api/chat', async (req, res) => {
  try {
    const { message, sessionId = 'default' } = req.body;
    
    if (!message) {
      return res.status(400).json({ error: 'Message requis' });
    }

    // R√©cup√©rer l'√©tat de session
    const sessionData = sessions.get(sessionId) || { step: 'initial' };
    
    // Traiter le message
    const result = await fapExpert.processMessage(message, sessionData.step);
    
    // Sauvegarder l'√©tat
    if (result.nextStep) {
      sessions.set(sessionId, { 
        step: result.nextStep,
        caseId: result.caseId,
        lastMessage: message 
      });
    }
    
    res.json({
      success: true,
      response: result.message,
      source: result.source,
      confidence: result.confidence || 0.8,
      ctas: result.ctas || [],
      sessionId: sessionId,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('‚ùå Erreur serveur:', error);
    res.status(500).json({ 
      error: 'Erreur interne du serveur',
      success: false
    });
  }
});

// Reset session
app.post('/api/reset', (req, res) => {
  const { sessionId = 'default' } = req.body;
  sessions.delete(sessionId);
  res.json({ success: true });
});

// Health check
app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'OK',
    timestamp: new Date().toISOString(),
    services: {
      fap_expert: `${FAP_EXPERT_DATABASE.length} cas FAP`,
      other_issues: `${OTHER_ISSUES_DB.length} autres cas`,
      claude: CLAUDE_API_KEY ? 'Configur√©' : 'Manquant'
    },
    version: 'FAP Expert Simple & Robuste'
  });
});

// Interface HTML
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'index.html'));
});

app.listen(port, () => {
  console.log(`üöÄ FAP Expert Simple d√©marr√© sur le port ${port}`);
  console.log(`üîß ${FAP_EXPERT_DATABASE.length} cas FAP + ${OTHER_ISSUES_DB.length} autres cas`);
  console.log(`ü§ñ Claude API: ${CLAUDE_API_KEY ? '‚úÖ' : '‚ùå'}`);
});
