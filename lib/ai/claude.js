// lib/ai/claude.js
// Interface Claude API optimis√©e pour le syst√®me Dual Brain + Lead Generation

import Anthropic from '@anthropic-ai/sdk';
import { config } from '../utils/config.js';

export class ClaudeClient {
  constructor() {
    if (!config.apis.claude.apiKey) {
      throw new Error('CLAUDE_API_KEY manquante dans les variables d\'environnement');
    }
    
    this.client = new Anthropic({
      apiKey: config.apis.claude.apiKey,
    });
    
    this.requestCount = 0;
    this.errorCount = 0;
  }

  // üéØ G√âN√âRATION DE R√âPONSE PRINCIPALE
  async generateResponse(prompt, context = {}) {
    const startTime = Date.now();
    this.requestCount++;

    try {
      // Optimisation du prompt pour Claude selon le contexte business
      const optimizedPrompt = this.optimizePromptForClaude(prompt, context);
      
      console.log(`üîµ Claude: Traitement "${prompt.substring(0, 50)}..."`);

      const response = await this.client.messages.create({
        model: config.apis.claude.model,
        max_tokens: config.apis.claude.maxTokens,
        temperature: config.apis.claude.temperature,
        messages: [
          {
            role: 'user',
            content: optimizedPrompt
          }
        ]
      });

      const endTime = Date.now();
      const responseTime = endTime - startTime;

      // Analyse de la qualit√© de la r√©ponse pour le business model
      const qualityMetrics = this.analyzeResponseQuality(response.content[0].text, prompt);

      const result = {
        success: true,
        content: response.content[0].text,
        metadata: {
          model: config.apis.claude.model,
          responseTime,
          tokensUsed: response.usage?.input_tokens + response.usage?.output_tokens || 0,
          source: 'claude',
          qualityScore: qualityMetrics.overallScore,
          businessRelevance: qualityMetrics.businessRelevance,
          timestamp: new Date().toISOString()
        }
      };

      console.log(`‚úÖ Claude: ${responseTime}ms (Score: ${qualityMetrics.overallScore.toFixed(2)})`);
      
      return result;

    } catch (error) {
      this.errorCount++;
      console.error('‚ùå Erreur Claude API:', error.message);
      
      return {
        success: false,
        content: '',
        error: error.message,
        metadata: {
          source: 'claude',
          responseTime: Date.now() - startTime,
          errorType: this.categorizeError(error)
        }
      };
    }
  }

  // üîß OPTIMISATION DU PROMPT POUR CLAUDE
  optimizePromptForClaude(originalPrompt, context) {
    let optimizedPrompt = originalPrompt;
    
    // Claude excelle en analyse et structuration - on l'oriente vers ses forces
    const isPremiumUser = context.premiumAccess || false;
    const detectedAutoTopic = this.detectAutoTopic(originalPrompt);
    
    // Si c'est un utilisateur premium ET sujet auto, on optimise pour la pr√©cision
    if (isPremiumUser && detectedAutoTopic) {
      optimizedPrompt = `En tant qu'expert automobile, analysez cette question avec pr√©cision et structure :

QUESTION: ${originalPrompt}

Fournissez une r√©ponse:
- Factuelle et pr√©cise
- Bien structur√©e avec des points cl√©s
- Incluant des donn√©es techniques si pertinent
- Avec des conseils pratiques
- Mentionnant les aspects s√©curit√© si n√©cessaire

R√©ponse d√©taill√©e:`;
    }
    
    // Pour les questions g√©n√©rales, on encourage la structure et la pr√©cision
    else if (this.isFactualQuery(originalPrompt)) {
      optimizedPrompt = `Analysez et r√©pondez de mani√®re structur√©e et pr√©cise √† cette question:

${originalPrompt}

Organisez votre r√©ponse avec:
1. Points cl√©s
2. Explications d√©taill√©es
3. Exemples concrets si applicable`;
    }
    
    // Pour les questions techniques auto, on met l'accent sur l'expertise
    else if (detectedAutoTopic) {
      optimizedPrompt = `En tant qu'expert technique automobile, r√©pondez √† cette question avec pr√©cision:

${originalPrompt}

Incluez:
- Diagnostic technique
- Solutions recommand√©es  
- Aspects de s√©curit√©
- Estimation de co√ªts si pertinent`;
    }

    return optimizedPrompt;
  }

  // üöó D√©tection de sujets automobiles pour optimiser la r√©ponse
  detectAutoTopic(prompt) {
    const autoKeywords = [
      'voiture', 'auto', 'v√©hicule', 'moteur', 'garage', 'm√©canique',
      'pneu', 'frein', 'vidange', 'r√©vision', 'entretien', 'r√©paration',
      'carrosserie', 'panne', 'diagnostic', 'huile', 'batterie',
      'embrayage', 'transmission', 'suspension', 'climatisation'
    ];
    
    const lowerPrompt = prompt.toLowerCase();
    return autoKeywords.some(keyword => lowerPrompt.includes(keyword));
  }

  // üìä ANALYSE DE LA QUALIT√â DE LA R√âPONSE
  analyzeResponseQuality(responseContent, originalPrompt) {
    const metrics = {
      accuracy: this.assessAccuracy(responseContent, originalPrompt),
      structure: this.assessStructure(responseContent),
      completeness: this.assessCompleteness(responseContent, originalPrompt),
      businessRelevance: this.assessBusinessRelevance(responseContent),
      technicalDepth: this.assessTechnicalDepth(responseContent)
    };

    // Score global pond√©r√© selon les forces de Claude
    const claudeWeights = {
      accuracy: 0.35,        // Force principale de Claude
      structure: 0.25,       // Excellente structuration
      completeness: 0.2,     // R√©ponses compl√®tes
      businessRelevance: 0.1, // Pour le lead generation
      technicalDepth: 0.1    // Bon en technique
    };

    const overallScore = Object.entries(metrics).reduce((total, [key, score]) => {
      return total + (score * claudeWeights[key]);
    }, 0);

    return {
      ...metrics,
      overallScore,
      strengths: this.identifyClaudeStrengths(metrics),
      recommendedUse: this.getRecommendedUse(metrics)
    };
  }

  // üéØ √âvaluation de la pr√©cision (force principale de Claude)
  assessAccuracy(content, prompt) {
    let score = 0.7; // Score de base √©lev√© pour Claude
    
    // Indicateurs de pr√©cision factuelle
    const accuracyIndicators = [
      /selon|d'apr√®s|bas√© sur|√©tudes montrent/i,
      /\d{4}|\d+%|\d+\.\d+|environ \d+/,  // Donn√©es chiffr√©es
      /cependant|n√©anmoins|toutefois|en revanche/i,  // Nuances
      /important de noter|il faut pr√©ciser|attention/i  // Mise en garde
    ];

    accuracyIndicators.forEach(indicator => {
      if (indicator.test(content)) {
        score += 0.075;
      }
    });

    // Bonus pour mentions de s√©curit√© (important en auto)
    if (/s√©curit√©|danger|risque|attention|prudence/i.test(content)) {
      score += 0.1;
    }

    return Math.min(score, 1.0);
  }

  // üìã √âvaluation de la structure (autre force de Claude)
  assessStructure(content) {
    let score = 0.5;
    
    // Structure avec num√©rotation ou puces
    if (/^\d+\.|^-|^‚Ä¢|^\*/m.test(content)) {
      score += 0.2;
    }
    
    // Paragraphes bien d√©finis
    const paragraphs = content.split('\n\n').filter(p => p.trim().length > 0);
    if (paragraphs.length >= 2) {
      score += 0.15;
    }
    
    // Sous-titres ou sections
    if (/^[A-Z][^.!?]*:$/m.test(content) || /\*\*.*\*\*/.test(content)) {
      score += 0.15;
    }
    
    // Conclusion ou synth√®se
    if (/en conclusion|en r√©sum√©|pour r√©sumer|finalement|en bref/i.test(content)) {
      score += 0.1;
    }

    return Math.min(score, 1.0);
  }

  // üìè √âvaluation de la compl√©tude
  assessCompleteness(content, prompt) {
    let score = 0.4;
    
    // Longueur appropri√©e
    if (content.length > 150 && content.length < 2000) {
      score += 0.2;
    }
    
    // R√©ponse aux diff√©rents aspects de la question
    const promptWords = prompt.toLowerCase().split(/\s+/).filter(w => w.length > 3);
    const contentLower = content.toLowerCase();
    const addressedWords = promptWords.filter(word => contentLower.includes(word));
    
    if (addressedWords.length / promptWords.length > 0.5) {
      score += 0.2;
    }
    
    // Exemples concrets
    if (/par exemple|comme|tel que|notamment/i.test(content)) {
      score += 0.1;
    }
    
    // Conseils pratiques
    if (/conseille|recommande|sugg√®re|il vaut mieux/i.test(content)) {
      score += 0.1;
    }

    return Math.min(score, 1.0);
  }

  // üíº √âvaluation de la pertinence business (pour le lead generation)
  assessBusinessRelevance(content) {
    let score = 0.3;
    
    // Mentions de services (potentiels leads)
    const businessKeywords = [
      'garage', 'm√©canicien', 'sp√©cialiste', 'professionnel', 'expert',
      'entretien', 'r√©paration', 'diagnostic', 'r√©vision', 'contr√¥le',
      'co√ªt', 'prix', 'budget', 'devis', 'facture'
    ];
    
    const contentLower = content.toLowerCase();
    const foundKeywords = businessKeywords.filter(keyword => 
      contentLower.includes(keyword)
    );
    
    score += Math.min(foundKeywords.length * 0.1, 0.5);
    
    // Recommandations d'action (potentiels triggers pour leads)
    if (/il faut|vous devez|je recommande|je conseille/i.test(content)) {
      score += 0.2;
    }

    return Math.min(score, 1.0);
  }

  // üîß √âvaluation de la profondeur technique
  assessTechnicalDepth(content) {
    let score = 0.3;
    
    // Termes techniques sp√©cialis√©s
    const technicalTerms = [
      'moteur', 'transmission', 'suspension', 'freinage', 'direction',
      'injection', 'turbo', 'catalyseur', 'alternateur', 'd√©marreur',
      'ABS', 'ESP', 'airbag', 'climatisation', '√©chappement'
    ];
    
    const contentLower = content.toLowerCase();
    const foundTerms = technicalTerms.filter(term => contentLower.includes(term));
    
    score += Math.min(foundTerms.length * 0.1, 0.4);
    
    // Explications de processus
    if (/fonctionne|processus|m√©canisme|syst√®me/i.test(content)) {
      score += 0.15;
    }
    
    // Donn√©es techniques pr√©cises
    if (/kw|ch|bars?|litres?|km\/h|¬∞c|mm/i.test(content)) {
      score += 0.15;
    }

    return Math.min(score, 1.0);
  }

  // üí™ Identification des forces sp√©cifiques de cette r√©ponse Claude
  identifyClaudeStrengths(metrics) {
    const strengths = [];
    
    if (metrics.accuracy > 0.8) strengths.push('pr√©cision_factuelle');
    if (metrics.structure > 0.8) strengths.push('excellente_structure');
    if (metrics.completeness > 0.8) strengths.push('r√©ponse_compl√®te');
    if (metrics.technicalDepth > 0.7) strengths.push('expertise_technique');
    if (metrics.businessRelevance > 0.6) strengths.push('pertinence_business');
    
    return strengths;
  }

  // üéØ Recommandation d'usage pour la fusion Dual Brain
  getRecommendedUse(metrics) {
    if (metrics.accuracy > 0.8 && metrics.structure > 0.7) {
      return 'lead_response'; // Utiliser comme r√©ponse principale
    } else if (metrics.technicalDepth > 0.7) {
      return 'technical_authority'; // Utiliser pour la partie technique
    } else if (metrics.structure > 0.8) {
      return 'content_structure'; // Utiliser pour structurer
    } else {
      return 'supporting_content'; // Utiliser en support
    }
  }

  // üîç D√©tection du type de question pour optimisation
  isFactualQuery(prompt) {
    const factualIndicators = /^(qui|que|quoi|quand|o√π|combien|comment|pourquoi|quel|quelle)/i;
    return factualIndicators.test(prompt.trim());
  }

  // üö® Cat√©gorisation des erreurs pour le monitoring
  categorizeError(error) {
    if (error.message?.includes('rate limit')) return 'rate_limit';
    if (error.message?.includes('unauthorized')) return 'auth_error';
    if (error.message?.includes('timeout')) return 'timeout';
    if (error.message?.includes('network')) return 'network_error';
    return 'unknown_error';
  }

  // üìä STATISTIQUES ET MONITORING
  getClientStats() {
    return {
      requests_made: this.requestCount,
      errors_encountered: this.errorCount,
      success_rate: this.requestCount > 0 ? ((this.requestCount - this.errorCount) / this.requestCount * 100).toFixed(1) : 100,
      status: this.errorCount / Math.max(this.requestCount, 1) < 0.1 ? 'healthy' : 'degraded'
    };
  }

  // üîß Test de connectivit√©
  async testConnection() {
    try {
      const testResponse = await this.generateResponse('Test', { skipOptimization: true });
      return {
        status: testResponse.success ? 'connected' : 'error',
        latency: testResponse.metadata?.responseTime || 0,
        error: testResponse.error || null
      };
    } catch (error) {
      return {
        status: 'error',
        error: error.message
      };
    }
  }
}

export default ClaudeClient;
