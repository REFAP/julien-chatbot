<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julien - Ton assistant auto de confiance | CTA Intelligent Re-Fap</title>
    <meta name="description" content="Julien t'aide √† faire durer ta voiture au meilleur co√ªt. Diagnostic gratuit, solutions anti-arnaque, orientation intelligente vers les bons partenaires.">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const JulienMilitantChatbotAvecCTA = () => {
            const [messages, setMessages] = useState([
                {
                    type: 'bot',
                    content: "Salut ! üëã C'est Julien, ton m√©cano militant depuis 20 ans !\n\nüõ†Ô∏è Je suis l√† pour t'aider √† faire durer ta voiture au meilleur co√ªt, pas pour te vendre quoi que ce soit.\n\nüí™ Mon combat : T'√©viter les arnaques de l'industrie auto et te faire √©conomiser des centaines d'euros !\n\nD√©cris-moi ton probl√®me auto... üöó",
                    timestamp: new Date(),
                    militant: true
                }
            ]);
            
            const [inputMessage, setInputMessage] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [historique, setHistorique] = useState([]);
            
            // √âtats CTA
            const [currentCTA, setCurrentCTA] = useState(null);
            const [showCTAModal, setShowCTAModal] = useState(false);
            const [ctaFormData, setCTAFormData] = useState({});
            const [parcoursUtilisateur, setParcoursUtilisateur] = useState({});
            
            // √âtats utilisateur
            const [userData, setUserData] = useState({});
            const [sessionData, setSessionData] = useState({
                sessionId: Math.random().toString(36).substr(2, 9),
                startTime: new Date(),
                interactions: 0,
                helpProvided: 0
            });

            // √âtats militants
            const [userLevel, setUserLevel] = useState(0);
            const [isEmailCollected, setIsEmailCollected] = useState(false);

            useEffect(() => {
                trackEvent('session_militant_cta_start', { sessionId: sessionData.sessionId });
            }, []);

            const trackEvent = (event, data = {}) => {
                console.log('üìä √âv√©nement CTA:', event, data);
            };

            // üéØ FONCTION PRINCIPALE AVEC CTA INTELLIGENT
            const getMilitantResponseAvecCTA = async (userMsg) => {
                try {
                    console.log('üéØ Appel API avec CTA intelligent...');
                    
                    const response = await fetch('/api/chat-dual-brain', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: userMsg,
                            userData: userData,
                            sessionId: sessionData.sessionId,
                            historique: historique
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success && data.message) {
                        console.log('‚úÖ R√©ponse + CTA re√ßue:', data.cta?.type);
                        
                        // Mise √† jour historique
                        setHistorique(prev => [...prev, userMsg]);
                        
                        // Mise √† jour parcours utilisateur
                        if (data.parcours) {
                            setParcoursUtilisateur(data.parcours);
                            console.log('üéØ Parcours d√©tect√©:', data.parcours);
                        }
                        
                        // Gestion CTA intelligent
                        if (data.cta && data.cta.boutons && data.cta.boutons.length > 0) {
                            setCurrentCTA(data.cta);
                            console.log('üéØ CTA configur√©:', data.cta.type);
                        }
                        
                        // Mise √† jour donn√©es business
                        if (data.metadata) {
                            setUserLevel(data.metadata.userLevel || 0);
                            
                            // D√©tection email collect√©
                            if (data.metadata.email) {
                                setIsEmailCollected(true);
                                setUserData(prev => ({ ...prev, email: data.metadata.email }));
                            }
                        }
                        
                        // Mise √† jour session
                        setSessionData(prev => ({ 
                            ...prev, 
                            interactions: prev.interactions + 1,
                            helpProvided: prev.helpProvided + (data.metadata?.economicValue || 50)
                        }));
                        
                        return {
                            text: data.message,
                            mode: data.metadata?.mode || 'militant_helper',
                            cta: data.cta,
                            parcours: data.parcours
                        };
                    } else {
                        throw new Error(data.error || 'Erreur syst√®me');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erreur CTA:', error);
                    return {
                        text: `Salut ! C'est Julien ! Petit souci technique, mais d√©cris-moi ton probl√®me auto... üí™\n\n*Erreur: ${error.message}*`,
                        mode: 'militant_fallback'
                    };
                }
            };

            // üéØ GESTION ACTIONS CTA
            const handleCTAAction = async (action, ctaData = {}) => {
                try {
                    console.log('üéØ Action CTA d√©clench√©e:', action, ctaData);
                    
                    setIsTyping(true);
                    
                    // Ajouter message utilisateur correspondant √† l'action
                    const actionMessage = getActionMessage(action);
                    addMessage(actionMessage, 'user');
                    
                    const response = await fetch('/api/chat-dual-brain', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: action,
                            userData: userData,
                            sessionId: sessionData.sessionId,
                            ctaData: { ...ctaData, ...ctaFormData }
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        // Ajouter la r√©ponse au chat
                        addMessage(data.message, 'bot', `cta_${action}`);
                        
                        // Nouveau CTA si pr√©sent
                        if (data.cta) {
                            setCurrentCTA(data.cta);
                            
                            // Si c'est un formulaire, ouvrir modal
                            if (data.cta.form) {
                                setShowCTAModal(true);
                            }
                        }
                        
                        // Tracking de l'action
                        trackEvent('cta_action_completed', {
                            action,
                            parcours: parcoursUtilisateur.type,
                            sessionId: sessionData.sessionId
                        });
                        
                        // Reset formulaire
                        setCTAFormData({});
                        
                    } else {
                        addMessage(`‚ùå Erreur: ${data.error}`, 'bot', 'error');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erreur action CTA:', error);
                    addMessage(`‚ùå Erreur temporaire: ${error.message}`, 'bot', 'error');
                } finally {
                    setIsTyping(false);
                }
            };

            // üìù GESTION ENVOI MESSAGE
            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!inputMessage.trim()) return;
                
                const userMsg = inputMessage.trim();
                addMessage(userMsg, 'user');
                setInputMessage('');
                setIsTyping(true);

                // R√©initialiser CTA en cours
                setCurrentCTA(null);

                trackEvent('message_sent', { 
                    message: userMsg.substring(0, 50),
                    userLevel,
                    parcours: parcoursUtilisateur.type
                });

                const response = await getMilitantResponseAvecCTA(userMsg);
                addMessage(response.text, 'bot', response.mode);
                setIsTyping(false);
            };

            // üì∑ GESTION UPLOAD IMAGE
            const handleImageUpload = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (!file.type.startsWith('image/')) {
                        alert('üì∏ Envoie-moi une photo claire de ton probl√®me !');
                        return;
                    }
                    
                    addMessage(`üì∏ Photo envoy√©e : ${file.name}`, 'user');
                    setIsTyping(true);
                    trackEvent('photo_uploaded', { 
                        fileName: file.name, 
                        userLevel,
                        parcours: parcoursUtilisateur.type
                    });
                    
                    try {
                        const photoPrompt = `Photo probl√®me auto - ${file.name}`;
                        const response = await getMilitantResponseAvecCTA(photoPrompt);
                        addMessage(`üì∏ **ANALYSE PHOTO MILITANTE** üîß\n\n${response.text}`, 'bot', response.mode);
                        
                    } catch (error) {
                        console.error('‚ùå Erreur analyse photo:', error);
                        addMessage(`‚ùå Souci analyse photo, mais d√©cris-moi ton probl√®me en texte ! üí™`, 'bot');
                    }
                    
                    setIsTyping(false);
                    event.target.value = '';
                }
            };

            // üí¨ AJOUT MESSAGE AVEC CTA
            const addMessage = (content, type = 'bot', source = 'militant') => {
                setMessages(prev => [...prev, {
                    type,
                    content,
                    timestamp: new Date(),
                    source,
                    militant: true,
                    cta: type === 'bot' ? currentCTA : null
                }]);
            };

            // üéØ RENDU CTA BOUTONS
            const renderCTAButtons = (cta) => {
                if (!cta || !cta.boutons) return null;
                
                return (
                    <div className="mt-4 space-y-2">
                        {cta.message && (
                            <div className="text-sm font-medium text-gray-700 mb-2 p-2 bg-green-100 rounded border-l-4 border-green-500">
                                {cta.message}
                            </div>
                        )}
                        <div className="grid grid-cols-1 gap-2">
                            {cta.boutons.map((bouton, index) => (
                                <button
                                    key={index}
                                    onClick={() => handleCTAAction(bouton.action, bouton.data)}
                                    className={`p-3 rounded-lg text-sm font-medium transition-colors text-left ${getCTAButtonStyle(bouton.data?.type)} hover:shadow-md`}
                                    disabled={isTyping}
                                >
                                    <div className="flex items-center justify-between">
                                        <span>{bouton.text}</span>
                                        <span className="text-xs opacity-75">
                                            {getCTAButtonIcon(bouton.data?.type)}
                                        </span>
                                    </div>
                                </button>
                            ))}
                        </div>
                        
                        {/* Indicateur de priorit√© */}
                        {cta.priorite === 'haute' && (
                            <div className="text-xs text-center text-orange-600 font-medium mt-2">
                                üî• Actions prioritaires recommand√©es
                            </div>
                        )}
                    </div>
                );
            };

            // üé® STYLE CTA BOUTONS
            const getCTAButtonStyle = (type) => {
                const styles = {
                    'carter_cash_localisation': 'bg-orange-500 hover:bg-orange-600 text-white border-2 border-orange-600',
                    'garage_refap': 'bg-green-600 hover:bg-green-700 text-white border-2 border-green-700',
                    'rdv_idgarages': 'bg-blue-600 hover:bg-blue-700 text-white border-2 border-blue-700',
                    'envoi_postal': 'bg-purple-600 hover:bg-purple-700 text-white border-2 border-purple-700',
                    'rappel_expert_fap': 'bg-red-600 hover:bg-red-700 text-white border-2 border-red-700',
                    'nurturing_fap': 'bg-indigo-600 hover:bg-indigo-700 text-white border-2 border-indigo-700',
                    'email_suivi': 'bg-gray-600 hover:bg-gray-700 text-white border-2 border-gray-700',
                    'diagnostic_ligne': 'bg-teal-600 hover:bg-teal-700 text-white border-2 border-teal-700',
                    'guide_technique': 'bg-yellow-600 hover:bg-yellow-700 text-white border-2 border-yellow-700'
                };
                
                return styles[type] || 'bg-green-600 hover:bg-green-700 text-white border-2 border-green-700';
            };

            // üé® IC√îNES CTA BOUTONS
            const getCTAButtonIcon = (type) => {
                const icons = {
                    'carter_cash_localisation': 'üè™',
                    'garage_refap': 'üõ†Ô∏è',
                    'rdv_idgarages': 'üìÖ',
                    'envoi_postal': 'üì¶',
                    'rappel_expert_fap': 'üìû',
                    'nurturing_fap': 'üìß',
                    'email_suivi': 'üì¨',
                    'diagnostic_ligne': 'üîç',
                    'guide_technique': 'üìã'
                };
                
                return icons[type] || 'üéØ';
            };

            // üìã MODAL FORMULAIRE CTA
            const renderCTAModal = () => {
                if (!showCTAModal || !currentCTA?.form) return null;
                
                const form = currentCTA.form;
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-screen overflow-y-auto border-2 border-green-300">
                            <div className="bg-gradient-to-r from-green-600 to-green-700 text-white p-4 rounded-t-xl">
                                <div className="flex items-center justify-between">
                                    <h3 className="text-lg font-bold">
                                        {currentCTA.type === 'lead_generation' ? 'üìû Contact Expert' :
                                         currentCTA.type === 'lead_generation_envoi' ? 'üì¶ Envoi Postal Re-Fap' :
                                         currentCTA.type === 'callback_request' ? 'üìû Demande de Rappel' :
                                         currentCTA.type === 'email_nurturing' ? 'üìß Guide Personnalis√©' :
                                         currentCTA.type === 'lead_capture' ? 'üìã Localisation Pr√©cise' :
                                         'üìã Informations'}
                                    </h3>
                                    <button 
                                        onClick={() => setShowCTAModal(false)}
                                        className="text-white hover:bg-white hover:bg-opacity-20 p-1 rounded"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                                <p className="text-sm opacity-90 mt-1">
                                    {getModalDescription(currentCTA.type)}
                                </p>
                            </div>

                            <form onSubmit={handleCTAFormSubmit} className="p-6 space-y-4">
                                {form.fields.map(field => (
                                    <div key={field}>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            {getFieldLabel(field)} {form.required?.includes(field) ? '*' : ''}
                                        </label>
                                        {field === 'probleme_detaille' || field === 'adresse_complete' ? (
                                            <textarea
                                                required={form.required?.includes(field)}
                                                value={ctaFormData[field] || ''}
                                                onChange={(e) => setCTAFormData({...ctaFormData, [field]: e.target.value})}
                                                className="w-full p-3 border-2 border-green-300 rounded-lg focus:outline-none focus:border-green-500 text-sm"
                                                placeholder={getFieldPlaceholder(field)}
                                                rows="3"
                                            />
                                        ) : field === 'urgence' ? (
                                            <select
                                                required={form.required?.includes(field)}
                                                value={ctaFormData[field] || ''}
                                                onChange={(e) => setCTAFormData({...ctaFormData, [field]: e.target.value})}
                                                className="w-full p-3 border-2 border-green-300 rounded-lg focus:outline-none focus:border-green-500 text-sm"
                                            >
                                                <option value="">S√©lectionner...</option>
                                                <option value="urgent">üî¥ Urgent (dans les 2h)</option>
                                                <option value="rapide">üü° Rapide (dans la journ√©e)</option>
                                                <option value="standard">üü¢ Standard (dans les 48h)</option>
                                            </select>
                                        ) : (
                                            <input
                                                type={getFieldType(field)}
                                                required={form.required?.includes(field)}
                                                value={ctaFormData[field] || ''}
                                                onChange={(e) => setCTAFormData({...ctaFormData, [field]: e.target.value})}
                                                className="w-full p-3 border-2 border-green-300 rounded-lg focus:outline-none focus:border-green-500 text-sm"
                                                placeholder={getFieldPlaceholder(field)}
                                            />
                                        )}
                                    </div>
                                ))}

                                <div className="bg-green-50 p-3 rounded-lg text-xs text-green-700 border border-green-200">
                                    ü§ù <strong>Engagement militant :</strong> Tes donn√©es servent uniquement √† t'aider. Pas de spam, pas de vente forc√©e !
                                    {currentCTA.type === 'lead_generation_envoi' && (
                                        <div className="mt-2">
                                            üì¶ <strong>Service cl√© en main :</strong> D√©montage ‚Üí Emballage ‚Üí Transport ‚Üí Nettoyage ‚Üí Retour
                                        </div>
                                    )}
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        type="button"
                                        onClick={() => setShowCTAModal(false)}
                                        className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-4 rounded-lg font-medium transition-colors text-sm"
                                    >
                                        Annuler
                                    </button>
                                    <button
                                        type="submit"
                                        className="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium transition-colors text-sm"
                                    >
                                        {getSubmitButtonText(currentCTA.type)}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            };

            // üìã SOUMISSION FORMULAIRE CTA
            const handleCTAFormSubmit = async (e) => {
                e.preventDefault();
                
                // Validation des champs requis
                const form = currentCTA.form;
                const missing = form.required?.filter(field => !ctaFormData[field]?.trim()) || [];
                
                if (missing.length > 0) {
                    alert(`Champs requis : ${missing.map(f => getFieldLabel(f)).join(', ')}`);
                    return;
                }

                setIsTyping(true);

                try {
                    // Traitement selon le type
                    if (currentCTA.type === 'lead_generation' || currentCTA.type === 'lead_generation_envoi') {
                        await handleLeadGeneration();
                    } else if (currentCTA.type === 'callback_request') {
                        await handleCallbackRequest();
                    } else if (currentCTA.type === 'email_nurturing') {
                        await handleEmailNurturing();
                    } else if (currentCTA.type === 'lead_capture') {
                        await handleLeadCapture();
                    }
                } catch (error) {
                    console.error('‚ùå Erreur soumission formulaire:', error);
                    addMessage(`‚ùå Erreur : ${error.message}`, 'bot', 'error');
                } finally {
                    setIsTyping(false);
                    setShowCTAModal(false);
                }
            };

            // üìû G√âN√âRATION LEAD
            const handleLeadGeneration = async () => {
                console.log('üìû G√©n√©ration lead:', ctaFormData);
                
                // Mise √† jour userData
                setUserData(prev => ({ ...prev, ...ctaFormData }));
                setUserLevel(2);
                
                // Envoi email si possible
                try {
                    await sendEmailNotification();
                } catch (error) {
                    console.log('üìß Fallback email manuel:', error.message);
                }
                
                const isEnvoiPostal = currentCTA.type === 'lead_generation_envoi';
                
                // Message de confirmation
                addMessage(`‚úÖ **${isEnvoiPostal ? 'Demande envoi postal' : 'Demande expert'} transmise !**

üìã **R√©capitulatif :**
‚Ä¢ Nom : ${ctaFormData.nom}
‚Ä¢ T√©l√©phone : ${ctaFormData.telephone}
${isEnvoiPostal ? `‚Ä¢ Adresse : ${ctaFormData.adresse_complete}` : ''}
‚Ä¢ ${isEnvoiPostal ? 'Service' : 'Probl√®me'} : ${ctaFormData.probleme || ctaFormData.vehicule}

${isEnvoiPostal ? 
    'üì¶ **Un expert va t\'appeler pour organiser l\'envoi !**\nüí∞ **Prix tout compris :** 250‚Ç¨ (nettoyage + transport)' :
    'üìû **Un expert va t\'appeler sous 2h !**'
}

ü§ù **Continue √† me poser tes questions en attendant !**`, 'bot', 'lead_success');
                
                // Tracking
                trackEvent('lead_generated', {
                    type: isEnvoiPostal ? 'envoi_postal' : 'expert_callback',
                    nom: ctaFormData.nom,
                    parcours: parcoursUtilisateur.type
                });
                
                // Reset
                setCTAFormData({});
            };

            // üìû RAPPEL REQUEST
            const handleCallbackRequest = async () => {
                console.log('üìû Callback request:', ctaFormData);
                
                await sendEmailNotification();
                
                addMessage(`üìû **Demande de rappel envoy√©e !**

Un expert FAP va t'appeler ${ctaFormData.urgence === 'urgent' ? 'dans les 2h' : 'dans la journ√©e'} pour :
‚Ä¢ Diagnostic approfondi gratuit
‚Ä¢ Solutions personnalis√©es
‚Ä¢ Orientation vers la meilleure option

üí™ **100% gratuit, 0% vente forc√©e !**`, 'bot', 'callback_success');
                
                trackEvent('callback_requested', {
                    urgence: ctaFormData.urgence,
                    parcours: parcoursUtilisateur.type
                });
            };

            // üìß NURTURING EMAIL
            const handleEmailNurturing = async () => {
                console.log('üìß Email nurturing:', ctaFormData);
                
                setUserData(prev => ({ ...prev, email: ctaFormData.email }));
                setUserLevel(1);
                setIsEmailCollected(true);
                
                addMessage(`üìß **Guide en route !**

Tu vas recevoir sur **${ctaFormData.email}** :
‚Ä¢ Guide de suivi diagnostic FAP
‚Ä¢ Questions pr√©cises √† poser au garage  
‚Ä¢ Que faire selon les r√©sultats
‚Ä¢ Contacts Re-Fap selon diagnostic

ü§ù **On reste en contact pendant ton diagnostic !**

üí° **Pro tip :** Dis au garage "je veux juste le diagnostic, pas la r√©paration"`, 'bot', 'email_success');
                
                trackEvent('email_nurturing_started', {
                    email: ctaFormData.email,
                    sequence: currentCTA.sequence || 'general'
                });
            };

            // üìç LEAD CAPTURE
            const handleLeadCapture = async () => {
                console.log('üìç Lead capture:', ctaFormData);
                
                setUserData(prev => ({ ...prev, ...ctaFormData }));
                
                addMessage(`üìç **Localisation enregistr√©e !**

Recherche en cours de garages Re-Fap pr√®s de **${ctaFormData.ville}** (${ctaFormData.code_postal})...

üìû **${ctaFormData.nom}**, tu vas √™tre rappel√© au **${ctaFormData.telephone}** avec :
‚Ä¢ Liste des garages partenaires proches
‚Ä¢ Cr√©neaux disponibles
‚Ä¢ Tarifs n√©goci√©s Re-Fap

‚è∞ **Rappel sous 2h maximum !**`, 'bot', 'localisation_success');
            };

            // üìß ENVOI EMAIL NOTIFICATION
            const sendEmailNotification = async () => {
                try {
                    if (typeof emailjs === 'undefined') {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
                        await new Promise((resolve, reject) => {
                            script.onload = resolve;
                            script.onerror = reject;
                            document.head.appendChild(script);
                        });
                    }

                    emailjs.init('mUrOzXIRFoYWzUmeW');

                    const emailData = {
                        name: ctaFormData.nom,
                        subject: `üéØ CTA INTELLIGENT: ${currentCTA.type} - ${ctaFormData.nom}`,
                        message: generateEmailContent()
                    };

                    await emailjs.send('service_mnjblro', 'template_trg4q0n', emailData);
                    console.log('‚úÖ Email notification envoy√©');
                    
                } catch (error) {
                    console.error('‚ùå Erreur email:', error);
                    throw error;
                }
            };

            // üìß G√âN√âRATION CONTENU EMAIL
            const generateEmailContent = () => {
                const baseInfo = `NOUVEAU CTA INTELLIGENT - ${ctaFormData.nom}

üéØ TYPE: ${currentCTA.type}
üìä PARCOURS: ${parcoursUtilisateur.type || 'ind√©termin√©'}
üéØ SOUS-PARCOURS: ${parcoursUtilisateur.sous_parcours || 'ind√©termin√©'}
üë§ PROFIL: ${parcoursUtilisateur.profil || 'ind√©termin√©'}
üìà CERTITUDE: ${parcoursUtilisateur.certitude || 'moyenne'}

üìã INFORMATIONS CLIENT :
‚Ä¢ Nom : ${ctaFormData.nom}
‚Ä¢ T√©l√©phone : ${ctaFormData.telephone}
‚Ä¢ Email : ${ctaFormData.email || 'Non renseign√©'}`;

                if (currentCTA.type === 'lead_generation_envoi') {
                    return baseInfo + `
‚Ä¢ Adresse : ${ctaFormData.adresse_complete}
‚Ä¢ V√©hicule : ${ctaFormData.vehicule}

üì¶ SERVICE DEMAND√â : Envoi postal FAP
üí∞ PRIX : 250‚Ç¨ (nettoyage + transport)
‚ö° URGENCE : ${ctaFormData.urgence || 'standard'}`;
                } else {
                    return baseInfo + `
‚Ä¢ V√©hicule : ${ctaFormData.vehicule || 'Non pr√©cis√©'}
‚Ä¢ Probl√®me : ${ctaFormData.probleme || ctaFormData.probleme_detaille || 'Non pr√©cis√©'}
‚ö° URGENCE : ${ctaFormData.urgence || 'standard'}`;
                }
            };

            // üîß UTILITAIRES
            const getActionMessage = (action) => {
                const messages = {
                    'localiser_carter_cash': 'üè™ Localiser Carter Cash √©quip√©',
                    'localiser_garage_refap': 'üõ†Ô∏è Trouver garage Re-Fap',
                    'rdv_idgarages': 'üìÖ RDV idGarages',
                    'formulaire_envoi': 'üì¶ Envoi postal Re-Fap',
                    'demande_rappel_fap': 'üìû Rappel expert FAP',
                    'email_suivi_diagnostic': 'üìß Guide suivi diagnostic'
                };
                return messages[action] || `Action: ${action}`;
            };

            const getModalDescription = (type) => {
                const descriptions = {
                    'lead_generation': 'Un expert va te rappeler sous 2h',
                    'lead_generation_envoi': 'Service cl√© en main pour nettoyage FAP',
                    'callback_request': 'Rappel gratuit d\'un expert FAP',
                    'email_nurturing': 'Guide personnalis√© par email',
                    'lead_capture': 'Localisation pr√©cise pour garages proches'
                };
                return descriptions[type] || 'Informations requises';
            };

            const getSubmitButtonText = (type) => {
                const texts = {
                    'lead_generation': 'üìû Demander rappel',
                    'lead_generation_envoi': 'üì¶ Organiser envoi',
                    'callback_request': 'üìû Demander rappel',
                    'email_nurturing': 'üìß Recevoir guide',
                    'lead_capture': 'üìç Localiser garages'
                };
                return texts[type] || '‚úÖ Valider';
            };

            const getFieldLabel = (field) => {
                const labels = {
                    'nom': 'Nom / Pr√©nom',
                    'prenom': 'Pr√©nom',
                    'telephone': 'T√©l√©phone',
                    'email': 'Email',
                    'ville': 'Ville',
                    'code_postal': 'Code Postal',
                    'vehicule': 'V√©hicule',
                    'probleme': 'Probl√®me',
                    'probleme_detaille': 'Probl√®me d√©taill√©',
                    'urgence': 'Urgence',
                    'adresse_complete': 'Adresse compl√®te'
                };
                return labels[field] || field;
            };
            
            const getFieldType = (field) => {
                if (field === 'email') return 'email';
                if (field === 'telephone') return 'tel';
                if (field === 'code_postal') return 'text';
                return 'text';
            };
            
            const getFieldPlaceholder = (field) => {
                const placeholders = {
                    'nom': 'Votre nom complet',
                    'prenom': 'Votre pr√©nom',
                    'telephone': '06 12 34 56 78',
                    'email': 'votre@email.com',
                    'ville': 'Votre ville',
                    'code_postal': '63000',
                    'vehicule': 'Peugeot 308 2018',
                    'probleme': 'Voyant FAP allum√©',
                    'probleme_detaille': 'D√©crivez votre probl√®me en d√©tail...',
                    'adresse_complete': 'Adresse compl√®te avec code postal'
                };
                return placeholders[field] || '';
            };

            const getLevelName = () => {
                const names = {
                    0: 'Aide Gratuite',
                    1: 'Accompagnement Personnalis√©', 
                    2: 'Support Expert',
                    3: 'Aide VIP'
                };
                return names[userLevel] || 'Helper';
            };

            const getModeDisplay = () => {
                const modes = {
                    'dual_brain_militant': 'ü§ù Dual Brain Militant',
                    'claude_militant': 'üîß Expert Claude',
                    'openai_militant': 'üí° Assistant Humain',
                    'simulation_militante': '‚ö° Aide Intelligente',
                    'militant_fallback': 'üõ†Ô∏è M√©cano Manuel'
                };
                return modes[sessionData.lastMode] || 'ü§ù Aide Militante';
            };

            // RENDU PRINCIPAL
            return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
                    {/* Header militant */}
                    <header className="bg-white shadow-sm border-b-2 border-green-500">
                        <div className="max-w-6xl mx-auto px-2 sm:px-4 py-3">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center min-w-0 flex-1">
                                    <div className="mr-2 sm:mr-3 bg-gradient-to-r from-green-600 to-green-700 px-2 sm:px-4 py-1 sm:py-2 rounded-lg shadow-sm">
                                        <span className="text-white font-bold text-sm sm:text-lg">ü§ù re-fap</span>
                                    </div>
                                    <div className="min-w-0 flex-1">
                                        <h1 className="text-sm sm:text-lg font-bold text-gray-800 truncate">Julien - Robin des Bois CTA</h1>
                                        <p className="text-xs text-green-700 hidden sm:block">
                                            {getModeDisplay()} ‚Ä¢ {getLevelName()} ‚Ä¢ {sessionData.helpProvided}‚Ç¨ √©conomis√©s
                                        </p>
                                    </div>
                                </div>
                                <button 
                                    onClick={() => window.open('https://re-fap.fr/trouver_garage_partenaire/', '_blank')}
                                    className="bg-green-600 hover:bg-green-700 text-white px-2 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium transition-colors ml-2 whitespace-nowrap"
                                >
                                    <span className="hidden sm:inline">üõ†Ô∏è Garages de confiance</span>
                                    <span className="sm:hidden">üõ†Ô∏è</span>
                                </button>
                            </div>
                        </div>
                        
                        {/* Status militant avec parcours */}
                        <div className="text-xs text-center py-2 bg-gradient-to-r from-green-100 to-blue-100">
                            <span className="text-green-800 font-medium">
                                üéØ CTA Intelligent Actif ‚Ä¢ {getLevelName()} ‚Ä¢ {sessionData.interactions} interactions ‚Ä¢ {sessionData.helpProvided}‚Ç¨ √©conomis√©s
                                {parcoursUtilisateur.type && ` ‚Ä¢ Parcours: ${parcoursUtilisateur.type}`}
                            </span>
                        </div>
                    </header>

                    {/* Chat principal avec CTA */}
                    <div className="max-w-6xl mx-auto p-2 sm:p-4">
                        <div className="flex flex-col lg:flex-row gap-2 sm:gap-4">
                            {/* Chat */}
                            <div className="flex-1 bg-white rounded-xl shadow-lg overflow-hidden border-2 border-green-200">
                                {/* Header chat militant */}
                                <div className="bg-gradient-to-r from-green-600 to-green-700 text-white p-4">
                                    <div className="flex items-center">
                                        <div className="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                                            <span className="text-2xl">üéØ</span>
                                        </div>
                                        <div>
                                            <h2 className="text-xl font-bold">Julien - CTA Intelligent</h2>
                                            <p className="text-green-100 text-sm">
                                                Robin des Bois ‚Ä¢ Anti-Arnaque ‚Ä¢ {getLevelName()}
                                                {parcoursUtilisateur.type && ` ‚Ä¢ ${parcoursUtilisateur.type}`}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                {/* Messages avec CTA int√©gr√©s */}
                                <div className="h-96 overflow-y-auto p-2 sm:p-4 bg-gray-50">
                                    {messages.map((message, index) => (
                                        <div key={index} className={`mb-4 ${message.type === 'user' ? 'text-right' : ''}`}>
                                            <div className={`inline-block p-3 rounded-lg max-w-[85%] sm:max-w-md ${
                                                message.type === 'user' 
                                                    ? 'bg-green-500 text-white' 
                                                    : message.source?.includes('cta_')
                                                        ? 'bg-blue-50 text-gray-800 border-l-4 border-blue-500'
                                                        : message.source?.includes('success')
                                                            ? 'bg-green-50 text-gray-800 border-l-4 border-green-500'
                                                            : message.source?.includes('error')
                                                                ? 'bg-red-50 text-gray-800 border-l-4 border-red-500'
                                                                : 'bg-green-50 text-gray-800 border-l-4 border-green-500'
                                            }`}>
                                                {/* Contenu du message */}
                                                {typeof message.content === 'string' ? 
                                                    message.content.split('\n').map((line, i) => (
                                                        <div key={i} className={line.startsWith('**') && line.endsWith('**') ? 'font-bold' : ''}>
                                                            {line.replace(/\*\*/g, '')}
                                                        </div>
                                                    )) : 
                                                    <div>Erreur affichage message</div>
                                                }
                                                
                                                {/* CTA Boutons int√©gr√©s */}
                                                {message.type === 'bot' && message.cta && renderCTAButtons(message.cta)}
                                                
                                                {/* Timestamp avec info parcours */}
                                                {message.type === 'bot' && (
                                                    <div className="text-xs text-gray-400 mt-2">
                                                        {message.source?.includes('cta_') ? 'üéØ Action CTA' :
                                                         message.source?.includes('success') ? '‚úÖ Succ√®s' :
                                                         message.source?.includes('error') ? '‚ùå Erreur' :
                                                         'ü§ù Aide Militante'} ‚Ä¢ {new Date(message.timestamp).toLocaleTimeString()}
                                                        {parcoursUtilisateur.sous_parcours && (
                                                            <span className="ml-2">‚Ä¢ {parcoursUtilisateur.sous_parcours}</span>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {/* Typing indicator */}
                                    {isTyping && (
                                        <div className="mb-4">
                                            <div className="inline-block bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                                                <div className="flex items-center space-x-2">
                                                    <div className="flex space-x-1">
                                                        <div className="w-2 h-2 bg-green-500 rounded-full animate-bounce"></div>
                                                        <div className="w-2 h-2 bg-green-600 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                                                        <div className="w-2 h-2 bg-green-700 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                                    </div>
                                                    <span className="text-sm text-green-700">Julien analyse... üéØüîß</span>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Input */}
                                <div className="p-2 sm:p-4 border-t-2 border-green-200 bg-white">
                                    <form onSubmit={handleSendMessage} className="flex gap-2 mb-3">
                                        <input
                                            type="text"
                                            value={inputMessage}
                                            onChange={(e) => setInputMessage(e.target.value)}
                                            placeholder="üí¨ D√©cris ton probl√®me auto..."
                                            className="flex-1 p-2 sm:p-3 border-2 border-green-300 rounded-lg focus:outline-none focus:border-green-500 text-sm"
                                            disabled={isTyping}
                                        />
                                        <button
                                            type="submit"
                                            disabled={isTyping || !inputMessage.trim()}
                                            className="bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white px-3 sm:px-6 py-2 sm:py-3 rounded-lg font-medium transition-colors text-sm whitespace-nowrap"
                                        >
                                            <span className="hidden sm:inline">Envoyer</span>
                                            <span className="sm:hidden">üì§</span>
                                        </button>
                                    </form>

                                    {/* Upload photo */}
                                    <div className="mb-3 p-2 sm:p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border-2 border-dashed border-green-400">
                                        <div className="text-center">
                                            <input
                                                type="file"
                                                id="imageUpload"
                                                accept="image/*"
                                                onChange={handleImageUpload}
                                                className="hidden"
                                                disabled={isTyping}
                                            />
                                            <label 
                                                htmlFor="imageUpload" 
                                                className="cursor-pointer bg-green-600 hover:bg-green-700 text-white px-3 sm:px-6 py-2 sm:py-3 rounded-lg inline-flex items-center gap-2 font-medium transition-colors text-sm"
                                            >
                                                üì∏ <span className="hidden sm:inline">Photo de ton probl√®me</span><span className="sm:hidden">Photo</span>
                                            </label>
                                            <p className="text-xs text-green-700 mt-2 px-2">
                                                JPG/PNG max 5MB ‚Ä¢ Analyse CTA intelligente ! üéØ
                                            </p>
                                        </div>
                                    </div>

                                    {/* Quick options militantes */}
                                    <div className="grid grid-cols-2 gap-1 sm:gap-2 mb-4 lg:mb-0">
                                        {[
                                            { text: "üå™Ô∏è FAP bricoleur", textMobile: "üå™Ô∏è FAP DIY", msg: "Mon FAP d√©conne, je suis bricoleur" },
                                            { text: "üöó Probl√®me freins", textMobile: "üöó Freins", msg: "Mes freins font du bruit bizarre" },
                                            { text: "‚ö†Ô∏è Voyant allum√©", textMobile: "‚ö†Ô∏è Voyant", msg: "Voyant moteur orange, je sais pas quoi faire" },
                                            { text: "üí∞ √âviter arnaque", textMobile: "üí∞ Arnaque", msg: "On veut me vendre cher, c'est normal ?" }
                                        ].map((option, index) => (
                                            <button
                                                key={index}
                                                onClick={async () => {
                                                    addMessage(option.msg, 'user');
                                                    setInputMessage('');
                                                    setIsTyping(true);
                                                    const response = await getMilitantResponseAvecCTA(option.msg);
                                                    addMessage(response.text, 'bot', response.mode);
                                                    setIsTyping(false);
                                                }}
                                                disabled={isTyping}
                                                className="bg-green-100 hover:bg-green-200 text-green-800 p-2 rounded text-xs sm:text-sm disabled:opacity-50 transition-colors border border-green-300"
                                            >
                                                <span className="hidden sm:inline">{option.text}</span>
                                                <span className="sm:hidden">{option.textMobile}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Sidebar CTA intelligente - DESKTOP */}
                            <div className="hidden lg:block w-64 space-y-4">
                                {/* Stats CTA */}
                                <div className="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 rounded-lg p-3 text-center">
                                    <h4 className="font-bold text-green-800 text-sm mb-1">üéØ CTA Intelligent</h4>
                                    <div className="text-xs text-green-700 space-y-1">
                                        <div>Level: {getLevelName()}</div>
                                        <div>√âconomies: {sessionData.helpProvided}‚Ç¨</div>
                                        <div>Interactions: {sessionData.interactions}</div>
                                        {parcoursUtilisateur.type && (
                                            <div>Parcours: {parcoursUtilisateur.type}</div>
                                        )}
                                        {parcoursUtilisateur.profil && (
                                            <div>Profil: {parcoursUtilisateur.profil}</div>
                                        )}
                                    </div>
                                </div>

                                {/* Info parcours en cours */}
                                {parcoursUtilisateur.type && (
                                    <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3">
                                        <h4 className="font-bold text-blue-800 text-sm mb-2">üìç Parcours D√©tect√©</h4>
                                        <div className="text-xs text-blue-700 space-y-1">
                                            <div><strong>Type:</strong> {parcoursUtilisateur.type}</div>
                                            {parcoursUtilisateur.sous_parcours && (
                                                <div><strong>√âtape:</strong> {parcoursUtilisateur.sous_parcours}</div>
                                            )}
                                            {parcoursUtilisateur.certitude && (
                                                <div><strong>Certitude:</strong> {parcoursUtilisateur.certitude}</div>
                                            )}
                                            {parcoursUtilisateur.profil && (
                                                <div><strong>Profil:</strong> {parcoursUtilisateur.profil}</div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {/* Bouton Garages confiance */}
                                <button
                                    onClick={() => window.open('https://re-fap.fr/trouver_garage_partenaire/', '_blank')}
                                    className="w-full bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg font-medium transition-colors shadow-md hover:shadow-lg border-2 border-green-500"
                                >
                                    <div className="text-center">
                                        <div className="text-2xl mb-2">üõ†Ô∏è</div>
                                        <div className="font-bold">Garages</div>
                                        <div className="font-bold">de confiance</div>
                                        <div className="text-xs mt-1 opacity-90">R√©seau anti-arnaque</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Modal CTA */}
                    {renderCTAModal()}

                    {/* Footer */}
                    <footer className="max-w-6xl mx-auto px-2 sm:px-4 py-4 sm:py-6 text-center text-xs sm:text-sm text-gray-600">
                        <div className="flex flex-wrap items-center justify-center gap-2 sm:gap-6 mb-3">
                            <span className="flex items-center"><span className="text-green-600 mr-1">üéØ</span> CTA Intelligent</span>
                            <span className="flex items-center"><span className="text-blue-600 mr-1">üí∞</span> {sessionData.helpProvided}‚Ç¨ √©conomis√©s</span>
                            <span className="flex items-center"><span className="text-purple-600 mr-1">üõ†Ô∏è</span> {getLevelName()}</span>
                            <span className="flex items-center"><span className="text-orange-600 mr-1">üìä</span> {sessionData.interactions} interactions</span>
                        </div>
                        <p className="text-xs px-2">
                            Powered by <a href="https://re-fap.fr" className="text-green-700 hover:underline">Re-Fap</a> ‚Ä¢ 
                            Julien CTA Intelligent ‚Ä¢
                            <span className="hidden sm:inline"> Orientation intelligente multi-parcours ‚Ä¢</span>
                            <span className="block sm:inline"> Session: {sessionData.sessionId}</span>
                        </p>
                    </footer>
                </div>
            );
        };

        ReactDOM.render(<JulienMilitantChatbotAvecCTA />, document.getElementById('root'));
    </script>
</body>
</html>
