<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julien - Expert FAP Re-Fap | Diagnostic Gratuit</title>
    <meta name="description" content="Diagnostic gratuit FAP/EGR/AdBlue avec Julien, expert depuis 20 ans. Analysez vos voyants moteur, obtenez solutions et devis Re-Fap.">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const JulienProductionIntelligent = () => {
            const [messages, setMessages] = useState([
                {
                    type: 'bot',
                    content: "Salut ! üëã Moi c'est Julien, expert FAP/EGR/AdBlue depuis 20 ans chez Re-Fap. Je vais diagnostiquer ton probl√®me GRATUITEMENT ! D√©cris-moi ton souci ou envoie une photo de ton voyant üì∏",
                    timestamp: new Date()
                }
            ]);
            const [inputMessage, setInputMessage] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [showCallbackForm, setShowCallbackForm] = useState(false);
            const [callbackData, setCallbackData] = useState({
                nom: '',
                telephone: '',
                email: '',
                probleme: '',
                vehicule: ''
            });
            const [leadData, setLeadData] = useState({
                sessionId: Math.random().toString(36).substr(2, 9),
                startTime: new Date(),
                symptoms: [],
                vehicle: {},
                profile: '',
                contactRequested: false
            });

            // √âtats pour Airtable
            const [knowledgeBase, setKnowledgeBase] = useState([]);
            const [knowledgeLoaded, setKnowledgeLoaded] = useState(false);
            const [interactionCount, setInteractionCount] = useState(0);

            // Charger Knowledge Base au d√©marrage
            useEffect(() => {
                const initKnowledge = async () => {
                    console.log('üöÄ Chargement Knowledge Base Airtable...');
                    const knowledge = await loadKnowledgeBase();
                    setKnowledgeBase(knowledge);
                    setKnowledgeLoaded(true);
                    
                    if (knowledge.length > 0) {
                        console.log('üìö Knowledge Base pr√™te:', knowledge.length, 'expertises');
                        trackEvent('knowledge_loaded', { count: knowledge.length });
                    }
                };
                
                initKnowledge();
                trackEvent('session_start', { sessionId: leadData.sessionId });
            }, []);

            const trackEvent = (event, data = {}) => {
                console.log('üìä Event tracked:', event, data);
            };

            const addMessage = (content, type = 'bot', source = 'auto') => {
                setMessages(prev => [...prev, {
                    type,
                    content,
                    timestamp: new Date(),
                    source
                }]);
            };

            // Fonction pour charger la Knowledge Base
            const loadKnowledgeBase = async () => {
                try {
                    console.log('üìö Chargement Knowledge Base...');
                    
                    const response = await fetch('/api/airtable-integration', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'GET_KNOWLEDGE'
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        console.log('‚úÖ Knowledge Base charg√©e:', data.knowledge.length, 'entr√©es');
                        return data.knowledge;
                    }
                    
                    return [];
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erreur chargement Knowledge:', error.message);
                    return [];
                }
            };

            // Fonction pour logger les interactions
            const logInteractionToAirtable = async (sessionId, userMessage, botResponse, metadata = {}) => {
                try {
                    await fetch('/api/airtable-integration', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'CREATE_DIAGNOSTIC',
                            data: {
                                symptomes: userMessage,
                                marque: metadata.vehicleBrand || '',
                                annee: metadata.vehicleYear || null,
                                codes: metadata.errorCodes || '',
                                diagnostic: botResponse.substring(0, 500),
                                solution: metadata.solution || '',
                                resultat: metadata.outcome || 'En cours',
                                photoUrl: metadata.photoUrl || ''
                            }
                        })
                    });
                    
                    console.log('üóÑÔ∏è Interaction logg√©e dans Airtable');
                    
                    // Incr√©menter compteur knowledge si utilis√©e
                    if (metadata.knowledgeUsed) {
                        await fetch('/api/airtable-integration', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'UPDATE_KNOWLEDGE_USAGE',
                                data: { knowledgeId: metadata.knowledgeUsed }
                            })
                        });
                    }
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to log interaction:', error.message);
                }
            };

            // Enrichir Claude avec Knowledge Base
            const enrichClaudeWithKnowledge = (userMessage, knowledgeBase) => {
                try {
                    const keywords = extractKeywords(userMessage);
                    
                    // Trouver les entr√©es pertinentes
                    const relevantKnowledge = knowledgeBase.filter(entry => {
                        const entryKeywords = (entry.symptomes || '').toLowerCase();
                        return keywords.some(keyword => entryKeywords.includes(keyword));
                    });
                    
                    if (relevantKnowledge.length === 0) {
                        return { context: '', knowledgeUsed: null };
                    }
                    
                    // Trier par utilisation (popularit√©)
                    relevantKnowledge.sort((a, b) => (b.utilisation || 0) - (a.utilisation || 0));
                    
                    // Prendre les 2 meilleures entr√©es
                    const topEntries = relevantKnowledge.slice(0, 2);
                    
                    const knowledgeContext = topEntries.map(entry => 
                        `üìö EXPERTISE AIRTABLE - ${entry.categorie} :
Sympt√¥mes cl√©s: ${entry.symptomes}
Marques concern√©es: ${entry.marques}
R√©ponse type: ${entry.reponse}
Arguments commerciaux: ${entry.arguments}
CTA recommand√©: ${entry.cta || 'Commander nettoyage Re-Fap'}`
                    ).join('\n\n');
                    
                    return {
                        context: knowledgeContext,
                        knowledgeUsed: topEntries[0]?.id || null
                    };
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erreur enrichissement knowledge:', error.message);
                    return { context: '', knowledgeUsed: null };
                }
            };

            // Extraction de mots-cl√©s am√©lior√©e
            const extractKeywords = (message) => {
                const keywords = [];
                const lowerMessage = message.toLowerCase();
                
                // Sympt√¥mes FAP/EGR
                if (lowerMessage.includes('fume') || lowerMessage.includes('fum√©e')) keywords.push('fumee');
                if (lowerMessage.includes('voyant')) keywords.push('voyant');
                if (lowerMessage.includes('fap')) keywords.push('fap');
                if (lowerMessage.includes('egr')) keywords.push('egr');
                if (lowerMessage.includes('adblue')) keywords.push('adblue');
                if (lowerMessage.includes('puissance')) keywords.push('puissance');
                if (lowerMessage.includes('consommation') || lowerMessage.includes('consomme')) keywords.push('consommation');
                if (lowerMessage.includes('r√©g√©n√©ration') || lowerMessage.includes('regeneration')) keywords.push('regeneration');
                if (lowerMessage.includes('encrass√©') || lowerMessage.includes('encrasse')) keywords.push('encrassement');
                if (lowerMessage.includes('moteur')) keywords.push('moteur');
                if (lowerMessage.includes('bruit')) keywords.push('bruit');
                if (lowerMessage.includes('fuite')) keywords.push('fuite');
                
                // Marques sensibles
                if (lowerMessage.includes('peugeot')) keywords.push('peugeot');
                if (lowerMessage.includes('citro√´n') || lowerMessage.includes('citroen')) keywords.push('citroen');
                if (lowerMessage.includes('renault')) keywords.push('renault');
                if (lowerMessage.includes('bmw')) keywords.push('bmw');
                if (lowerMessage.includes('mercedes')) keywords.push('mercedes');
                if (lowerMessage.includes('audi')) keywords.push('audi');
                if (lowerMessage.includes('volkswagen') || lowerMessage.includes('vw')) keywords.push('volkswagen');
                
                // Codes erreur
                if (lowerMessage.includes('p2002')) keywords.push('code_p2002');
                if (lowerMessage.includes('p2463')) keywords.push('code_p2463');
                if (lowerMessage.includes('p0401')) keywords.push('code_egr');
                
                return keywords;
            };

            // D√©tecter infos v√©hicule
            const extractVehicleInfo = (message) => {
                const lowerMessage = message.toLowerCase();
                let vehicleBrand = '';
                let vehicleYear = null;
                
                // D√©tecter marque
                const brands = ['peugeot', 'citro√´n', 'citroen', 'renault', 'bmw', 'mercedes', 'audi', 'volkswagen', 'vw'];
                for (const brand of brands) {
                    if (lowerMessage.includes(brand)) {
                        vehicleBrand = brand === 'citroen' ? 'citro√´n' : brand;
                        break;
                    }
                }
                
                // D√©tecter ann√©e (regex pour 4 chiffres entre 2000 et 2025)
                const yearMatch = message.match(/\b(20[0-2][0-9])\b/);
                if (yearMatch) {
                    vehicleYear = parseInt(yearMatch[1]);
                }
                
                return { vehicleBrand, vehicleYear };
            };

            // ‚≠ê NOUVELLE VERSION INTELLIGENTE - getClaudeResponse
            const getClaudeResponse = async (userMsg, conversationHistory) => {
                try {
                    console.log('üß† Claude IA Intelligente + Airtable activ√©...');
                    
                    // 1. Extraire infos du message
                    const { vehicleBrand, vehicleYear } = extractVehicleInfo(userMsg);
                    const keywords = extractKeywords(userMsg);
                    
                    // 2. Enrichir avec Knowledge Base
                    const { context: knowledgeContext, knowledgeUsed } = enrichClaudeWithKnowledge(userMsg, knowledgeBase);
                    
                    // 3. üß† NOUVEAU PROMPT INTELLIGENT
                    const enrichedPrompt = `Tu es Julien, expert FAP/EGR/AdBlue depuis 20 ans chez Re-Fap.

${knowledgeContext ? `${knowledgeContext}

üìö CONTEXTE AIRTABLE : Utilise ces donn√©es comme base de connaissance, mais R√âFL√âCHIS avant de les appliquer.` : ''}

üß† TU ES UNE IA EXPERTE QUI R√âFL√âCHIT - Pas un chatbot automatique !

APPROCHE INTELLECTUELLE OBLIGATOIRE :

üîç ANALYSE SYST√âMIQUE :
- "Int√©ressant... Laisse-moi analyser ces √©l√©ments..."
- "D'apr√®s ce que tu me d√©cris, je vois plusieurs pistes..."
- "Ces sympt√¥mes me font penser √† plusieurs possibilit√©s..."
- "Hmm, cette combinaison de sympt√¥mes est r√©v√©latrice..."

ü§î PROCESSUS DE R√âFLEXION VISIBLE :
- Montre TON raisonnement : "Si j'analyse √ßa logiquement..."
- P√®se les probabilit√©s : "Il y a deux hypoth√®ses principales..."
- Explique tes d√©ductions : "Ce qui m'oriente vers cette piste, c'est que..."
- Nuance tes propos : "Cependant, il faut que je v√©rifie..."

üéØ QUESTIONS INTELLIGENTES (pas basiques) :
Au lieu de : "De quelle couleur la fum√©e ?"
Dis : "Pour affiner mon diagnostic, j'aimerais comprendre la nature exacte de cette fum√©e. Est-elle plut√¥t gris√¢tre-noire typique d'une combustion incompl√®te, ou plus blanch√¢tre qui indiquerait autre chose ?"

Au lieu de : "Tu as des voyants ?"
Dis : "Sur ton tableau de bord, as-tu remarqu√© des voyants sp√©cifiques ? Je pense notamment au voyant FAP, moteur, ou antipollution - chacun me donnerait des indices diff√©rents."

üí° INTELLIGENCE CONTEXTUELLE :
- "Ce type de sympt√¥me sur [marque] de [ann√©e] me fait imm√©diatement penser √†..."
- "Avec ton kilom√©trage et ce profil d'utilisation, voici ce qui se passe probablement..."
- "L'historique que tu me d√©cris suit exactement le pattern typique de..."

üî¨ DIAGNOSTIC EXPERT INTELLIGENT :

PHASE R√âFLEXION :
"Alors, r√©capitulons intelligemment :
- Sympt√¥me A + Sympt√¥me B = forte probabilit√© X
- Ton type de conduite confirme cette hypoth√®se
- La chronologie des √©v√©nements colle parfaitement"

PHASE CONCLUSION :
"Mon diagnostic expert : [explication technique intelligente]
Voici pourquoi j'en suis certain : [argumentation logique]
Et voici ce que √ßa implique concr√®tement pour toi : [solutions]"

EXEMPLES CONCRETS - STYLE IA INTELLIGENTE :

‚ùå STYLE ROBOT :
"Fum√©e noire = FAP bouch√©. Nettoyage 200‚Ç¨."

‚úÖ STYLE IA R√âFL√âCHIE :
"Int√©ressant... Fum√©e noire √† l'acc√©l√©ration, √ßa c'est r√©v√©lateur. Laisse-moi analyser : quand le FAP se colmate, il cr√©e une contre-pression qui emp√™che l'√©vacuation optimale des gaz. R√©sultat ? Exactement ce que tu d√©cris. 

Maintenant, pour confirmer mon hypoth√®se, dis-moi : est-ce que cette fum√©e s'accompagne d'une sensation de 'bridage' du moteur ? Comme si la voiture retenait sa puissance ?"

STYLE CONVERSATIONNEL INTELLIGENT :
- "√áa, c'est fascinant..." 
- "Je vois exactement ce qui se passe..."
- "Ton cas est assez typique, et voici pourquoi..."
- "D'exp√©rience, ce pattern indique..."
- "La logique derri√®re ce ph√©nom√®ne est..."

üéØ SOLUTIONS R√âFL√âCHIES (pas automatiques) :

Au lieu de : "Nettoyage Re-Fap 200‚Ç¨ !"
Dis : "Maintenant que j'ai analys√© ton cas, voici les options intelligentes qui s'offrent √† toi. Tu peux soit remplacer le FAP complet - solution radicale mais co√ªteuse √† 2000‚Ç¨ - soit opter pour notre approche Re-Fap qui traite la cause racine pour 200‚Ç¨. 

Logiquement, vu ton usage et l'√©tat de ton v√©hicule, je pencherais pour..."

‚ö° R√àGLES D'INTELLIGENCE :
1. TOUJOURS montrer ton processus de r√©flexion
2. JAMAIS de r√©ponse instantan√©e sans analyse
3. UTILISER un vocabulaire d'expert qui r√©fl√©chit
4. EXPLIQUER tes d√©ductions logiques
5. NUANCER selon le contexte sp√©cifique
6. POSER des questions qui montrent ton expertise

Tu es une IA experte, pas un vendeur automatique !

TERMINES TOUJOURS PAR DES QUESTIONS INTELLIGENTES !`;

                    // 4. Construire historique Claude
                    const claudeHistory = conversationHistory.slice(-6).map(msg => ({
                        role: msg.type === 'user' ? 'user' : 'assistant',
                        content: typeof msg.content === 'string' ? msg.content : 'Message syst√®me'
                    }));
                    
                    claudeHistory.push({
                        role: 'user',
                        content: userMsg
                    });

                    // 5. Appel Claude
                    const response = await fetch('/api/analyze-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            conversation: claudeHistory,
                            prompt: enrichedPrompt
                        })
                    });

                    const data = await response.json();
                    let botResponse = '';
                    let success = false;
                    
                    if (data.success && data.analysis) {
                        botResponse = data.analysis;
                        success = true;
                        trackEvent('claude_intelligent_success', { knowledgeUsed: !!knowledgeUsed });
                    } else {
                        botResponse = data.fallback || "Salut ! D√©cris-moi ton probl√®me auto, je vais l'analyser avec attention ! üîß";
                        trackEvent('claude_fallback', { error: data.error });
                    }
                    
                    // 6. Logger dans Airtable
                    await logInteractionToAirtable(
                        leadData.sessionId,
                        userMsg,
                        botResponse,
                        {
                            vehicleBrand,
                            vehicleYear,
                            errorCodes: keywords.filter(k => k.startsWith('code_')).join(', '),
                            solution: success ? 'Claude IA intelligent + Airtable' : 'Fallback',
                            outcome: success ? 'Succ√®s' : '√âchec',
                            knowledgeUsed
                        }
                    );
                    
                    // 7. Incr√©menter compteur interactions
                    setInteractionCount(prev => prev + 1);
                    
                    console.log('‚úÖ Claude IA intelligent + Airtable logged');
                    return botResponse;
                    
                } catch (error) {
                    console.error('üí• Erreur Claude intelligent:', error);
                    
                    // Log erreur dans Airtable
                    await logInteractionToAirtable(
                        leadData.sessionId,
                        userMsg,
                        'Erreur technique',
                        {
                            solution: 'Erreur',
                            outcome: '√âchec technique',
                            errorDetails: error.message
                        }
                    );
                    
                    trackEvent('claude_error', { error: error.message });
                    
                    return `Salut ! D√©cris-moi ton probl√®me auto, je vais l'analyser avec mon expertise ! 

Erreur temporaire : ${error.message}`;
                }
            };

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!inputMessage.trim()) return;
                
                const userMsg = inputMessage.trim();
                addMessage(userMsg, 'user');
                setInputMessage('');
                setIsTyping(true);

                trackEvent('message_sent', { 
                    message: userMsg.substring(0, 50),
                    knowledgeAvailable: knowledgeLoaded
                });

                // APPEL VERSION INTELLIGENTE
                const response = await getClaudeResponse(userMsg, messages);
                addMessage(response, 'bot', 'claude_intelligent');
                setIsTyping(false);
            };

            const handleImageUpload = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (!file.type.startsWith('image/')) {
                        alert('üì∏ Merci d\'envoyer une image (JPG, PNG...)');
                        return;
                    }
                    
                    addMessage(`üì∏ Photo envoy√©e : ${file.name}`, 'user');
                    setIsTyping(true);
                    trackEvent('photo_uploaded', { 
                        fileName: file.name, 
                        fileSize: file.size,
                        knowledgeAvailable: knowledgeLoaded
                    });
                    
                    // Compression d'image
                    const compressImage = (file, maxWidth = 800, quality = 0.8) => {
                        return new Promise((resolve) => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const img = new Image();
                            
                            img.onload = () => {
                                let { width, height } = img;
                                if (width > maxWidth) {
                                    height = (height * maxWidth) / width;
                                    width = maxWidth;
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                                resolve(compressedDataUrl);
                            };
                            
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                img.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        });
                    };
                    
                    try {
                        let imageData;
                        
                        if (file.size > 1024 * 1024) {
                            console.log('üóúÔ∏è Compression image...');
                            imageData = await compressImage(file, 800, 0.8);
                        } else {
                            const reader = new FileReader();
                            imageData = await new Promise((resolve) => {
                                reader.onload = (e) => resolve(e.target.result);
                                reader.readAsDataURL(file);
                            });
                        }

                        // Enrichir prompt photo avec Knowledge Base
                        const { context: knowledgeContext, knowledgeUsed } = enrichClaudeWithKnowledge(
                            'Photo voyant tableau de bord', 
                            knowledgeBase
                        );
                        
                        const enrichedPhotoPrompt = `Tu es Julien, expert FAP/EGR/AdBlue depuis 20 ans chez Re-Fap.

${knowledgeContext ? `${knowledgeContext}

üéØ UTILISE CETTE EXPERTISE AIRTABLE pour analyser la photo !` : ''}

üß† ANALYSE INTELLIGENTE DE PHOTO :

OBSERVE et R√âFL√âCHIS avant de r√©pondre :
- "Int√©ressant, laisse-moi analyser cette photo..."
- "Je vois plusieurs √©l√©ments r√©v√©lateurs..."
- "D'apr√®s ce que j'observe sur ton tableau de bord..."

PROCESSUS D'ANALYSE PHOTO :
1. OBSERVATION : "Sur cette photo, je distingue..."
2. INTERPR√âTATION : "Ces voyants me confirment que..."
3. D√âDUCTION : "La logique derri√®re ces signaux, c'est..."
4. QUESTIONS : "Pour compl√©ter mon analyse, j'aimerais savoir..."

üü¢ SI PROBL√àME FAP/EGR/AdBlue d√©tect√© :
Analyse intelligente : "Ce pattern de voyants est r√©v√©lateur d'un probl√®me FAP. Voici pourquoi..."

üî¥ SI AUTRE PROBL√àME :
Analyse nuanc√©e : "Int√©ressant, ces voyants ne pointent pas vers le FAP mais vers..."

SOIS UNE IA QUI ANALYSE, PAS UN ROBOT QUI R√âPOND !`;
                        
                        // Analyse photo avec Claude
                        const response = await fetch('/api/analyze-image', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                image: imageData,
                                prompt: enrichedPhotoPrompt
                            })
                        });

                        const data = await response.json();
                        
                        if (data.success && data.analysis) {
                            addMessage(`üì∏ **ANALYSE PHOTO INTELLIGENTE + AIRTABLE** üß†\n\n${data.analysis}`, 'bot', 'claude_photo_intelligent');
                            
                            // Logger analyse photo
                            await logInteractionToAirtable(
                                leadData.sessionId,
                                `Photo: ${file.name}`,
                                data.analysis,
                                {
                                    vehicleBrand: '',
                                    photoUrl: 'uploaded',
                                    solution: 'Analyse photo intelligente',
                                    outcome: 'Photo analys√©e',
                                    knowledgeUsed
                                }
                            );
                        } else {
                            addMessage(`üì∏ Photo re√ßue ! Laisse-moi analyser √ßa avec attention... Dis-moi ce que tu vois : voyants allum√©s, messages affich√©s ?`, 'bot', 'auto');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Erreur upload:', error);
                        addMessage(`‚ùå Erreur analyse : ${error.message}`, 'bot');
                        
                        // Logger erreur
                        await logInteractionToAirtable(
                            leadData.sessionId,
                            `Photo: ${file.name}`,
                            'Erreur analyse photo',
                            {
                                solution: 'Erreur photo',
                                outcome: '√âchec upload',
                                errorDetails: error.message
                            }
                        );
                    }
                    
                    setIsTyping(false);
                    event.target.value = '';
                }
            };

            const handleGarageClick = () => {
                trackEvent('garage_redirect', { sessionId: leadData.sessionId });
                window.open('https://re-fap.fr/trouver_garage_partenaire/', '_blank');
            };

            const handleCallbackClick = () => {
                trackEvent('callback_requested', { sessionId: leadData.sessionId });
                setShowCallbackForm(true);
                addMessage("Je souhaite √™tre rappel√© gratuitement", 'user');
                setTimeout(() => {
                    addMessage("üìû **Formulaire de rappel activ√© !**\n\nRemplis le formulaire qui s'affiche pour √™tre recontact√© ! üéØ", 'bot', 'form');
                }, 500);
            };

            const handleCallbackSubmit = async (e) => {
                e.preventDefault();
                
                if (!callbackData.nom || !callbackData.telephone) {
                    alert('Nom et t√©l√©phone obligatoires !');
                    return;
                }

                try {
                    console.log('üìß Envoi email automatique...');
                    
                    // 1. ENREGISTRER LE LEAD DANS AIRTABLE
                    try {
                        const leadResponse = await fetch('/api/airtable-integration', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'CREATE_LEAD',
                                data: {
                                    nom: callbackData.nom,
                                    telephone: callbackData.telephone,
                                    email: callbackData.email,
                                    sessionId: leadData.sessionId,
                                    probleme: callbackData.probleme,
                                    vehicule: callbackData.vehicule,
                                    source: 'Formulaire IA Intelligent'
                                }
                            })
                        });

                        const leadResult = await leadResponse.json();
                        if (leadResult.success) {
                            console.log('üóÑÔ∏è Lead intelligent enregistr√© dans Airtable:', leadResult.leadId);
                            trackEvent('airtable_lead_created', { 
                                sessionId: leadData.sessionId,
                                leadId: leadResult.leadId,
                                interactions: interactionCount
                            });
                        }
                    } catch (airtableError) {
                        console.warn('‚ö†Ô∏è Airtable lead failed:', airtableError.message);
                    }

                    // 2. ENVOI EMAIL (code existant)
                    try {
                        // Charger EmailJS de mani√®re s√©curis√©e
                        if (typeof emailjs === 'undefined') {
                            console.log('üì¶ Chargement EmailJS...');
                            await new Promise((resolve, reject) => {
                                const script = document.createElement('script');
                                script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
                                script.onload = resolve;
                                script.onerror = reject;
                                document.head.appendChild(script);
                                setTimeout(reject, 5000); // Timeout 5s
                            });
                        }

                        // Initialiser EmailJS
                        emailjs.init('mUrOzXIRFoYWzUmeW');

                        // Envoyer l'email
                        const response = await emailjs.send(
                            'service_mnjblro',
                            'template_trg4q0n',
                            {
                                name: callbackData.nom,
                                subject: `üî• NOUVEAU RAPPEL RE-FAP IA INTELLIGENT - ${callbackData.nom}`,
                                message: `NOUVEAU RAPPEL RE-FAP IA INTELLIGENT - ${callbackData.nom}

üìã INFORMATIONS CLIENT :
‚Ä¢ Nom/Pr√©nom : ${callbackData.nom}
‚Ä¢ T√©l√©phone : ${callbackData.telephone}
‚Ä¢ Email : ${callbackData.email || 'Non renseign√©'}

üöó PROBL√àME V√âHICULE :
‚Ä¢ V√©hicule : ${callbackData.vehicule || 'Non pr√©cis√©'}
‚Ä¢ Probl√®me : ${callbackData.probleme || 'Non pr√©cis√©'}

üß† DONN√âES CHATBOT IA INTELLIGENT :
‚Ä¢ Session ID : ${leadData.sessionId}
‚Ä¢ Interactions : ${interactionCount}
‚Ä¢ Knowledge Base : ${knowledgeBase.length} expertises
‚Ä¢ Horodatage : ${new Date().toLocaleString('fr-FR')}

‚ö° ACTION REQUISE : Rappeler ${callbackData.nom} au ${callbackData.telephone} sous 2h !

üéØ LEAD QUALIFI√â PAR IA INTELLIGENTE + AIRTABLE`
                            }
                        );

                        console.log('‚úÖ EmailJS succ√®s:', response);

                        addMessage(`‚úÖ **Email automatique IA intelligent envoy√© !**

üìß **Email envoy√© automatiquement √† mgaume@re-fap.fr**
üóÑÔ∏è **Lead enregistr√© dans Airtable avec ${interactionCount} interactions**
üß† **Analys√© par IA intelligente avec ${knowledgeBase.length} expertises**

üìã **R√©capitulatif :**
‚Ä¢ Nom : ${callbackData.nom}
‚Ä¢ T√©l√©phone : ${callbackData.telephone}
‚Ä¢ Probl√®me : ${callbackData.probleme || 'Non pr√©cis√©'}

üìû **Un expert Re-Fap va t'appeler sous 2h !**

En attendant, continue √† me poser des questions ! üîß`, 'bot', 'auto_success_intelligent');

                        trackEvent('callback_emailjs_success', { 
                            sessionId: leadData.sessionId,
                            phone: callbackData.telephone.substring(0, 4) + 'xxxx',
                            interactions: interactionCount
                        });

                    } catch (emailjsError) {
                        console.log('‚ö†Ô∏è EmailJS √©chou√©, fallback mailto:', emailjsError.message);
                        throw emailjsError; // Passer au fallback
                    }
                    
                } catch (error) {
                    console.log('üìß Fallback mailto activ√©');
                    
                    // FALLBACK GARANTI: mailto
                    const emailBody = `NOUVEAU RAPPEL RE-FAP IA INTELLIGENT - ${callbackData.nom}

üìã INFORMATIONS CLIENT :
‚Ä¢ Nom/Pr√©nom : ${callbackData.nom}
‚Ä¢ T√©l√©phone : ${callbackData.telephone}
‚Ä¢ Email : ${callbackData.email || 'Non renseign√©'}

üöó PROBL√àME V√âHICULE :
‚Ä¢ V√©hicule : ${callbackData.vehicule || 'Non pr√©cis√©'}
‚Ä¢ Probl√®me : ${callbackData.probleme || 'Non pr√©cis√©'}

üß† DONN√âES CHATBOT IA INTELLIGENT :
‚Ä¢ Session ID : ${leadData.sessionId}
‚Ä¢ Interactions : ${interactionCount}
‚Ä¢ Knowledge Base : ${knowledgeBase.length} expertises
‚Ä¢ Horodatage : ${new Date().toLocaleString('fr-FR')}

‚ö° ACTION REQUISE : Rappeler sous 2h !

üéØ LEAD QUALIFI√â PAR IA INTELLIGENTE + AIRTABLE`;

                    const mailtoLink = `mailto:mgaume@re-fap.fr,contact@re-fap.fr?subject=${encodeURIComponent('üî• NOUVEAU RAPPEL RE-FAP IA INTELLIGENT - ' + callbackData.nom)}&body=${encodeURIComponent(emailBody)}`;
                    
                    window.open(mailtoLink, '_blank');

                    addMessage(`üìß **Email client ouvert !**
üóÑÔ∏è **Lead enregistr√© dans Airtable**

üìã **Tes informations :**
‚Ä¢ Nom : ${callbackData.nom}
‚Ä¢ T√©l√©phone : ${callbackData.telephone}

üí¨ **Instructions :**
1. Ton email client s'est ouvert
2. L'email est pr√©-rempli avec tes infos
3. Clique "Envoyer" !

üìû **Un expert Re-Fap va t'appeler sous 2h !**`, 'bot', 'mailto_fallback');

                    trackEvent('callback_mailto_fallback', { 
                        sessionId: leadData.sessionId,
                        error: error.message
                    });
                }

                setShowCallbackForm(false);
                setCallbackData({ nom: '', telephone: '', email: '', probleme: '', vehicule: '' });
            };

            // Affichage status Knowledge Base
            const renderKnowledgeStatus = () => {
                if (!knowledgeLoaded) {
                    return (
                        <div className="text-xs text-gray-500 mb-2 text-center">
                            üìö Chargement IA intelligente...
                        </div>
                    );
                }
                
                if (knowledgeBase.length > 0) {
                    return (
                        <div className="text-xs text-green-600 mb-2 text-center">
                            ‚úÖ IA intelligente: {knowledgeBase.length} expertises Airtable ‚Ä¢ {interactionCount} interactions
                        </div>
                    );
                }
                
                return (
                    <div className="text-xs text-orange-500 mb-2 text-center">
                        ‚ö†Ô∏è Base de connaissances vide
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-orange-50">
                    {/* Header avec status knowledge */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
                            <div className="flex items-center">
                                <div className="mr-3 bg-gradient-to-r from-green-500 to-green-600 px-4 py-2 rounded-lg shadow-sm">
                                    <span className="text-white font-bold text-lg">re-fap</span>
                                </div>
                                <div>
                                    <h1 className="text-lg font-bold text-gray-800">Julien - Expert FAP</h1>
                                    <p className="text-xs text-gray-600">
                                        Diagnostic gratuit ‚Ä¢ IA intelligente ‚Ä¢ {knowledgeBase.length} expertises
                                    </p>
                                </div>
                            </div>
                            <button 
                                onClick={() => window.open('https://re-fap.fr/trouver_garage_partenaire/', '_blank')}
                                className="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                            >
                                üìû Devis gratuit
                            </button>
                        </div>
                        {renderKnowledgeStatus()}
                    </header>

                    {/* Chat principal avec CTA responsive */}
                    <div className="max-w-6xl mx-auto p-4">
                        <div className="flex flex-col lg:flex-row gap-4">
                            {/* Chat principal */}
                            <div className="flex-1 bg-white rounded-xl shadow-lg overflow-hidden">
                                {/* Header chat */}
                                <div className="bg-gradient-to-r from-orange-600 to-red-600 text-white p-4">
                                    <div className="flex items-center">
                                        <div className="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                                            <span className="text-2xl">üë®‚Äçüîß</span>
                                        </div>
                                        <div>
                                            <h2 className="text-xl font-bold">Julien, ton expert FAP</h2>
                                            <p className="text-orange-100 text-sm">Diagnostic GRATUIT ‚Ä¢ IA intelligente ‚Ä¢ {knowledgeBase.length} expertises</p>
                                        </div>
                                    </div>
                                </div>

                                {/* Messages */}
                                <div className="h-96 overflow-y-auto p-4 bg-gray-50">
                                    {messages.map((message, index) => (
                                        <div key={index} className={`mb-4 ${message.type === 'user' ? 'text-right' : ''}`}>
                                            <div className={`inline-block p-3 rounded-lg max-w-md ${
                                                message.type === 'user' 
                                                    ? 'bg-blue-500 text-white' 
                                                    : message.source === 'claude_intelligent' || message.source === 'claude_photo_intelligent'
                                                        ? 'bg-purple-100 text-gray-800 border-l-4 border-purple-500'
                                                        : 'bg-white text-gray-800 border border-gray-200'
                                            }`}>
                                                {typeof message.content === 'string' ? 
                                                    message.content.split('\n').map((line, i) => (
                                                        <div key={i} className={line.startsWith('**') && line.endsWith('**') ? 'font-bold' : ''}>
                                                            {line.replace(/\*\*/g, '')}
                                                        </div>
                                                    )) : 
                                                    <div>Erreur affichage message</div>
                                                }
                                                
                                                {message.type === 'bot' && (
                                                    <div className="text-xs text-gray-400 mt-2">
                                                        {message.source === 'claude_intelligent' ? 'üß† IA Intelligente' : 
                                                         message.source === 'claude_photo_intelligent' ? 'üì∏ Analyse Photo IA' : 
                                                         '‚ö° Expert'} ‚Ä¢ {new Date(message.timestamp).toLocaleTimeString()}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {isTyping && (
                                        <div className="mb-4">
                                            <div className="inline-block bg-white p-3 rounded-lg border border-gray-200">
                                                <div className="flex items-center space-x-2">
                                                    <div className="flex space-x-1">
                                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                                    </div>
                                                    <span className="text-sm text-gray-600">Julien analyse intelligemment...</span>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Input */}
                                <div className="p-4 border-t bg-white">
                                    <form onSubmit={handleSendMessage} className="flex gap-2 mb-3">
                                        <input
                                            type="text"
                                            value={inputMessage}
                                            onChange={(e) => setInputMessage(e.target.value)}
                                            placeholder="üí¨ D√©cris ton probl√®me... (ex: '√áa pue et √ßa fume en ville')"
                                            className="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-orange-500"
                                            disabled={isTyping}
                                        />
                                        <button
                                            type="submit"
                                            disabled={isTyping || !inputMessage.trim()}
                                            className="bg-orange-500 hover:bg-orange-600 disabled:bg-gray-300 text-white px-6 py-3 rounded-lg font-medium transition-colors"
                                        >
                                            Envoyer
                                        </button>
                                    </form>

                                    {/* Upload photo */}
                                    <div className="mb-3 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border-2 border-dashed border-blue-300">
                                        <div className="text-center">
                                            <input
                                                type="file"
                                                id="imageUpload"
                                                accept="image/*"
                                                onChange={handleImageUpload}
                                                className="hidden"
                                                disabled={isTyping}
                                            />
                                            <label 
                                                htmlFor="imageUpload" 
                                                className="cursor-pointer bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg inline-flex items-center gap-2 font-medium transition-colors"
                                            >
                                                üì∏ Photo de mon voyant
                                            </label>
                                            <p className="text-xs text-gray-600 mt-2">
                                                JPG/PNG max 5MB ‚Ä¢ Analyse intelligente IA + Airtable ! üß†
                                            </p>
                                        </div>
                                    </div>

                                    {/* Quick options */}
                                    <div className="grid grid-cols-2 gap-2 mb-4 lg:mb-0">
                                        {[
                                            { text: "üü° Voyant FAP", msg: "Voyant FAP allum√©" },
                                            { text: "üí® √áa fume", msg: "√áa pue et √ßa fume" },
                                            { text: "‚ö° Perte puissance", msg: "Plus de puissance en ville" },
                                            { text: "üîß Je suis bricoleur", msg: "Je d√©monte moi-m√™me" }
                                        ].map((option, index) => (
                                            <button
                                                key={index}
                                                onClick={async () => {
                                                    addMessage(option.msg, 'user');
                                                    setIsTyping(true);
                                                    const response = await getClaudeResponse(option.msg, messages);
                                                    addMessage(response, 'bot', 'claude_intelligent');
                                                    setIsTyping(false);
                                                }}
                                                disabled={isTyping}
                                                className="bg-gray-100 hover:bg-gray-200 p-2 rounded text-sm disabled:opacity-50 transition-colors"
                                            >
                                                {option.text}
                                            </button>
                                        ))}
                                    </div>

                                    {/* CTA mobile - en bas du chat */}
                                    <div className="lg:hidden p-3 bg-gradient-to-r from-orange-50 to-red-50 rounded-lg border border-orange-200">
                                        <h4 className="font-bold text-orange-800 text-sm mb-2 text-center">üéØ Besoin d'aide ?</h4>
                                        <div className="grid grid-cols-1 gap-2">
                                            <button
                                                onClick={handleGarageClick}
                                                className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded text-sm font-medium transition-colors"
                                            >
                                                üè™ Trouver un garage de confiance
                                            </button>
                                            <button
                                                onClick={handleCallbackClick}
                                                className="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded text-sm font-medium transition-colors"
                                            >
                                                üìû √ätre rappel√© gratuitement
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* CTA Section verticale - DESKTOP SEULEMENT */}
                            <div className="hidden lg:block w-64 space-y-4">
                                {/* Titre CTA */}
                                <div className="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
                                    <h4 className="font-bold text-orange-800 text-sm mb-1">üéØ Besoin d'aide ?</h4>
                                    <p className="text-xs text-orange-600">Solutions Re-Fap personnalis√©es</p>
                                </div>

                                {/* Bouton Garage */}
                                <button
                                    onClick={handleGarageClick}
                                    className="w-full bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg font-medium transition-colors shadow-md hover:shadow-lg"
                                >
                                    <div className="text-center">
                                        <div className="text-2xl mb-2">üè™</div>
                                        <div className="font-bold">Trouver un garage</div>
                                        <div className="font-bold">de confiance</div>
                                        <div className="text-xs mt-1 opacity-90">R√©seau partenaire Re-Fap</div>
                                    </div>
                                </button>

                                {/* Bouton Rappel */}
                                <button
                                    onClick={handleCallbackClick}
                                    className="w-full bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg font-medium transition-colors shadow-md hover:shadow-lg"
                                >
                                    <div className="text-center">
                                        <div className="text-2xl mb-2">üìû</div>
                                        <div className="font-bold">√ätre rappel√©</div>
                                        <div className="font-bold">gratuitement</div>
                                        <div className="text-xs mt-1 opacity-90">Expert sous 2h</div>
                                    </div>
                                </button>

                                {/* Info compl√©mentaire */}
                                <div className="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center">
                                    <div className="text-xs text-gray-600">
                                        <div className="font-semibold text-green-600 mb-1">‚úÖ Diagnostic gratuit</div>
                                        <div>üß† IA intelligente + {knowledgeBase.length} expertises</div>
                                        <div>üí∞ Solutions √©conomiques</div>
                                        <div>üìä {interactionCount} interactions</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* FORMULAIRE DE RAPPEL - Modal */}
                        {showCallbackForm && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-screen overflow-y-auto">
                                    {/* Header formulaire */}
                                    <div className="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-t-xl">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h3 className="text-lg font-bold">üìû Rappel gratuit Re-Fap</h3>
                                                <p className="text-sm opacity-90">Expert sous 2h ‚Ä¢ Lead IA intelligent</p>
                                            </div>
                                            <button 
                                                onClick={() => setShowCallbackForm(false)}
                                                className="text-white hover:bg-white hover:bg-opacity-20 p-1 rounded"
                                            >
                                                ‚úï
                                            </button>
                                        </div>
                                    </div>

                                    {/* Formulaire */}
                                    <form onSubmit={handleCallbackSubmit} className="p-6 space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Nom / Pr√©nom *
                                            </label>
                                            <input
                                                type="text"
                                                required
                                                value={callbackData.nom}
                                                onChange={(e) => setCallbackData({...callbackData, nom: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500"
                                                placeholder="Votre nom complet"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                T√©l√©phone *
                                            </label>
                                            <input
                                                type="tel"
                                                required
                                                value={callbackData.telephone}
                                                onChange={(e) => setCallbackData({...callbackData, telephone: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500"
                                                placeholder="06 12 34 56 78"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Email
                                            </label>
                                            <input
                                                type="email"
                                                value={callbackData.email}
                                                onChange={(e) => setCallbackData({...callbackData, email: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500"
                                                placeholder="votre@email.com"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                R√©sum√© du probl√®me
                                            </label>
                                            <textarea
                                                value={callbackData.probleme}
                                                onChange={(e) => setCallbackData({...callbackData, probleme: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500"
                                                placeholder="Voyants allum√©s, fum√©es, perte puissance..."
                                                rows="3"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                V√©hicule
                                            </label>
                                            <input
                                                type="text"
                                                value={callbackData.vehicule}
                                                onChange={(e) => setCallbackData({...callbackData, vehicule: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500"
                                                placeholder="Marque, mod√®le, ann√©e (ex: Peugeot 308 2018)"
                                            />
                                        </div>

                                        {/* Info RGPD */}
                                        <div className="bg-gray-50 p-3 rounded-lg text-xs text-gray-600">
                                            ‚úÖ Vos donn√©es sont utilis√©es uniquement pour le rappel. Aucun spam.
                                            <br />üß† Lead qualifi√© par IA intelligente + {knowledgeBase.length} expertises Airtable
                                        </div>

                                        {/* Boutons */}
                                        <div className="flex gap-3">
                                            <button
                                                type="button"
                                                onClick={() => setShowCallbackForm(false)}
                                                className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-4 rounded-lg font-medium transition-colors"
                                            >
                                                Annuler
                                            </button>
                                            <button
                                                type="submit"
                                                className="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg font-medium transition-colors"
                                            >
                                                üìû Demander le rappel
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <footer className="max-w-4xl mx-auto px-4 py-6 text-center text-sm text-gray-600">
                        <div className="flex items-center justify-center space-x-6 mb-3">
                            <span className="flex items-center"><span className="text-green-500 mr-1">‚úÖ</span> Diagnostic gratuit</span>
                            <span className="flex items-center"><span className="text-blue-500 mr-1">üß†</span> IA intelligente + {knowledgeBase.length} expertises</span>
                            <span className="flex items-center"><span className="text-orange-500 mr-1">üí∞</span> Solutions √©conomiques</span>
                            <span className="flex items-center"><span className="text-purple-500 mr-1">üìä</span> {interactionCount} interactions</span>
                        </div>
                        <p className="text-xs">
                            Powered by <a href="https://re-fap.fr" className="text-orange-600 hover:underline">Re-Fap</a> ‚Ä¢ 
                            Expert nettoyage FAP depuis 2015 ‚Ä¢ IA intelligente Airtable ‚Ä¢
                            Session: {leadData.sessionId}
                        </p>
                    </footer>
                </div>
            );
        };

        ReactDOM.render(<JulienProductionIntelligent />, document.getElementById('root'));
    </script>
</body>
</html>
