<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julien - Expert FAP Re-Fap | Diagnostic Dual Brain IA</title>
    <meta name="description" content="Diagnostic gratuit FAP/EGR/AdBlue avec Julien, expert IA Dual Brain. Claude+OpenAI pour solutions premium.">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const JulienDualBrainChatbot = () => {
            const [messages, setMessages] = useState([
                {
                    type: 'bot',
                    content: "Salut ! üëã Moi c'est Julien, expert FAP/EGR/AdBlue depuis 20 ans chez Re-Fap.\n\nüß† **Mon IA Dual Brain (Claude + OpenAI)** va diagnostiquer ton probl√®me GRATUITEMENT !\n\nD√©cris-moi ton souci ou envoie une photo üì∏",
                    timestamp: new Date(),
                    source: 'intro'
                }
            ]);
            const [inputMessage, setInputMessage] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [showCallbackForm, setShowCallbackForm] = useState(false);
            const [showUpgradeForm, setShowUpgradeForm] = useState(false);
            const [userData, setUserData] = useState({});
            const [callbackData, setCallbackData] = useState({
                nom: '',
                telephone: '',
                email: '',
                probleme: '',
                vehicule: ''
            });
            const [leadData, setLeadData] = useState({
                sessionId: Math.random().toString(36).substr(2, 9),
                startTime: new Date(),
                interactions: 0
            });

            // √âtats Dual Brain
            const [userLevel, setUserLevel] = useState(0);
            const [aiMode, setAiMode] = useState('‚ö° Simulation');
            const [leadValue, setLeadValue] = useState(0);
            const [conversionStrategy, setConversionStrategy] = useState(null);
            
            // Ref pour scroll automatique
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            useEffect(() => {
                trackEvent('session_start', { sessionId: leadData.sessionId });
            }, []);

            const trackEvent = (event, data = {}) => {
                console.log('üìä Event tracked:', event, data);
            };

            const addMessage = (content, type = 'bot', source = 'auto') => {
                setMessages(prev => [...prev, {
                    type,
                    content,
                    timestamp: new Date(),
                    source
                }]);
            };

            // üß† FONCTION DUAL BRAIN PRINCIPALE
            const getDualBrainResponse = async (userMsg) => {
                try {
                    console.log('üß† Dual Brain IA activ√©...');
                    
                    // Appel au Dual Brain am√©lior√©
                    const response = await fetch('/api/chat-dual-brain', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: userMsg,
                            userData: userData,
                            sessionId: leadData.sessionId
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success && data.message) {
                        console.log('‚úÖ Dual Brain success:', data.metadata?.aiMode);
                        
                        // Mise √† jour des donn√©es business
                        if (data.rewardSystem) {
                            setUserLevel(data.rewardSystem.userLevel);
                            setLeadValue(data.rewardSystem.leadValue);
                            setConversionStrategy(data.rewardSystem.conversionStrategy);
                        }
                        
                        if (data.metadata) {
                            setAiMode(data.metadata.aiMode || 'Dual Brain');
                            setLeadData(prev => ({ ...prev, interactions: prev.interactions + 1 }));
                            
                            // Si email d√©tect√©, mise √† jour userData
                            if (data.metadata.email) {
                                setUserData(prev => ({ ...prev, email: data.metadata.email }));
                                setUserLevel(1);
                            }
                        }
                        
                        // Proposition d'upgrade si strategy disponible
                        if (data.rewardSystem?.conversionStrategy && userLevel === 0) {
                            setTimeout(() => {
                                setShowUpgradeForm(true);
                            }, 3000);
                        }
                        
                        return {
                            text: data.message,
                            mode: data.metadata?.aiMode || 'Dual Brain',
                            score: data.metadata?.score || 8.0
                        };
                    } else {
                        throw new Error(data.error || 'Erreur Dual Brain');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erreur Dual Brain:', error);
                    return {
                        text: `Salut ! D√©cris-moi ton probl√®me auto, je vais l'analyser ! üîß\n\nErreur temporaire : ${error.message}`,
                        mode: 'Fallback',
                        score: 5.0
                    };
                }
            };

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!inputMessage.trim()) return;
                
                const userMsg = inputMessage.trim();
                addMessage(userMsg, 'user');
                setInputMessage('');
                setIsTyping(true);

                trackEvent('message_sent', { 
                    message: userMsg.substring(0, 50),
                    userLevel
                });

                // Appel Dual Brain
                const response = await getDualBrainResponse(userMsg);
                addMessage(response.text, 'bot', response.mode);
                setIsTyping(false);
            };

            const handleImageUpload = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (!file.type.startsWith('image/')) {
                        alert('üì∏ Merci d\'envoyer une image (JPG, PNG...)');
                        return;
                    }
                    
                    addMessage(`üì∏ Photo envoy√©e : ${file.name}`, 'user');
                    setIsTyping(true);
                    trackEvent('photo_uploaded', { 
                        fileName: file.name, 
                        fileSize: file.size,
                        userLevel
                    });
                    
                    try {
                        // Compression d'image
                        const compressImage = (file, maxWidth = 800, quality = 0.8) => {
                            return new Promise((resolve) => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const img = new Image();
                                
                                img.onload = () => {
                                    let { width, height } = img;
                                    if (width > maxWidth) {
                                        height = (height * maxWidth) / width;
                                        width = maxWidth;
                                    }
                                    
                                    canvas.width = width;
                                    canvas.height = height;
                                    ctx.drawImage(img, 0, 0, width, height);
                                    
                                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                                    resolve(compressedDataUrl);
                                };
                                
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    img.src = e.target.result;
                                };
                                reader.readAsDataURL(file);
                            });
                        };
                        
                        let imageData;
                        
                        if (file.size > 1024 * 1024) {
                            console.log('üóúÔ∏è Compression image...');
                            imageData = await compressImage(file, 800, 0.8);
                        } else {
                            const reader = new FileReader();
                            imageData = await new Promise((resolve) => {
                                reader.onload = (e) => resolve(e.target.result);
                                reader.readAsDataURL(file);
                            });
                        }

                        // Analyse photo avec IA
                        const photoResponse = await fetch('/api/analyze-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                image: imageData,
                                prompt: `Analyse cette photo de voyant/probl√®me auto comme Julien expert Re-Fap`
                            })
                        });

                        const photoData = await photoResponse.json();
                        
                        if (photoData.success) {
                            addMessage(`üì∏ **ANALYSE PHOTO DUAL BRAIN** üß†\n\n${photoData.analysis}`, 'bot', 'üì∏ Vision IA');
                        } else {
                            addMessage(`üì∏ **Analyse photo** : ${photoData.fallback || 'Erreur analyse image'}`, 'bot', 'üì∏ Fallback');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Erreur upload:', error);
                        addMessage(`‚ùå Erreur analyse : ${error.message}`, 'bot');
                    }
                    
                    setIsTyping(false);
                    event.target.value = '';
                }
            };

            const handleGarageClick = () => {
                trackEvent('garage_redirect', { sessionId: leadData.sessionId, userLevel });
                window.open('https://re-fap.fr/trouver_garage_partenaire/', '_blank');
            };

            const handleCallbackClick = () => {
                trackEvent('callback_requested', { sessionId: leadData.sessionId, userLevel });
                setShowCallbackForm(true);
                addMessage("Je souhaite √™tre rappel√© gratuitement", 'user');
                setTimeout(() => {
                    addMessage("üìû **Formulaire de rappel activ√© !**\n\nRemplis le formulaire pour √™tre recontact√© par un expert Re-Fap ! üéØ", 'bot', 'form');
                }, 500);
            };

            const handleUpgradeClick = () => {
                setShowUpgradeForm(true);
                trackEvent('upgrade_requested', { userLevel, leadValue });
            };

            const handleUpgradeSubmit = async (e) => {
                e.preventDefault();
                
                if (!callbackData.email) {
                    alert('Email obligatoire pour le diagnostic premium !');
                    return;
                }

                try {
                    // Cr√©ation du lead via API
                    const leadResponse = await fetch('/api/chat-dual-brain', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'CREATE_LEAD',
                            userData: {
                                email: callbackData.email,
                                firstName: callbackData.nom,
                                location: callbackData.vehicule
                            },
                            sessionId: leadData.sessionId,
                            message: `Upgrade premium: ${callbackData.nom}`
                        })
                    });

                    const leadResult = await leadResponse.json();

                    // Mise √† jour userData
                    const newUserData = {
                        ...userData,
                        email: callbackData.email,
                        firstName: callbackData.nom,
                        location: callbackData.vehicule
                    };
                    setUserData(newUserData);
                    setUserLevel(1);

                    addMessage(`‚úÖ **Diagnostic Premium Activ√© !** üéØ\n\nMerci ${callbackData.nom} ! Ton niveau utilisateur a √©t√© upgrad√© vers premium.\n\nüß† **Dual Brain Claude + OpenAI** maintenant disponible !\n\nPose-moi maintenant ta question pour une analyse premium !`, 'bot', 'upgrade_success');

                    setShowUpgradeForm(false);
                    setCallbackData({ nom: '', telephone: '', email: '', probleme: '', vehicule: '' });
                    
                    trackEvent('upgrade_completed', { newLevel: 1, email: callbackData.email });

                } catch (error) {
                    console.error('Erreur upgrade:', error);
                    addMessage(`‚ùå Erreur upgrade : ${error.message}`, 'bot');
                }
            };

            const handleCallbackSubmit = async (e) => {
                e.preventDefault();
                
                if (!callbackData.nom || !callbackData.telephone) {
                    alert('Nom et t√©l√©phone obligatoires !');
                    return;
                }

                try {
                    // Mise √† jour userData pour niveau 2
                    const newUserData = {
                        ...userData,
                        email: callbackData.email,
                        phone: callbackData.telephone,
                        firstName: callbackData.nom,
                        vehicleModel: callbackData.vehicule
                    };
                    setUserData(newUserData);
                    setUserLevel(2);

                    // Cr√©ation du lead
                    const leadResponse = await fetch('/api/chat-dual-brain', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'CREATE_LEAD',
                            userData: newUserData,
                            sessionId: leadData.sessionId,
                            message: `Lead rappel: ${callbackData.probleme}`
                        })
                    });

                    const leadResult = await leadResponse.json();

                    // Envoi email via API callback
                    const emailResponse = await fetch('/api/send-callback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            nom: callbackData.nom,
                            telephone: callbackData.telephone,
                            email: callbackData.email || 'Non renseign√©',
                            probleme: callbackData.probleme || 'Non pr√©cis√©',
                            vehicule: callbackData.vehicule || 'Non pr√©cis√©',
                            sessionId: leadData.sessionId,
                            chatUrl: window.location.href
                        })
                    });

                    const emailResult = await emailResponse.json();

                    if (emailResult.success) {
                        addMessage(`‚úÖ **Lead Dual Brain envoy√© !**\n\nüìß **Email automatique envoy√© √† mgaume@re-fap.fr**\nüß† **Analys√© par Dual Brain IA (Claude + OpenAI)**\nüí∞ **Valeur lead : ${leadValue}‚Ç¨**\n\nüìã **R√©capitulatif :**\n‚Ä¢ Nom : ${callbackData.nom}\n‚Ä¢ T√©l√©phone : ${callbackData.telephone}\n‚Ä¢ Level : Premium (${userLevel})\n\nüìû **Un expert va t'appeler sous 2h !**\n\nContinue √† me poser des questions pour l'analyse premium ! üîß`, 'bot', 'dual_brain_success');
                    } else {
                        // Fallback mailto
                        const emailBody = `NOUVEAU LEAD DUAL BRAIN IA - ${callbackData.nom}\n\nüß† DUAL BRAIN IA : Claude + OpenAI\nüí∞ Valeur lead : ${leadValue}‚Ç¨\nüìä Level : ${userLevel}\nüéØ Interactions : ${leadData.interactions}\n\nüìã INFORMATIONS :\n‚Ä¢ Nom : ${callbackData.nom}\n‚Ä¢ T√©l√©phone : ${callbackData.telephone}\n‚Ä¢ Email : ${callbackData.email || 'Non renseign√©'}\n‚Ä¢ V√©hicule : ${callbackData.vehicule || 'Non pr√©cis√©'}\n‚Ä¢ Probl√®me : ${callbackData.probleme || 'Non pr√©cis√©'}\n\nSession: ${leadData.sessionId}`;

                        const mailtoLink = `mailto:mgaume@re-fap.fr?subject=${encodeURIComponent('üß† LEAD DUAL BRAIN IA - ' + callbackData.nom)}&body=${encodeURIComponent(emailBody)}`;
                        
                        window.open(mailtoLink, '_blank');

                        addMessage(`üìß **Email client ouvert !**\nüß† **Lead Dual Brain g√©n√©r√© (${leadValue}‚Ç¨)**\n\nüí¨ **Instructions :**\n1. Email pr√©-rempli ouvert\n2. Clique "Envoyer"\n3. Rappel sous 2h garanti !\n\nüéØ **Ton niveau premium est activ√© !**`, 'bot', 'mailto_fallback');
                    }

                } catch (error) {
                    console.error('Erreur callback:', error);
                    addMessage(`‚ùå Erreur envoi : ${error.message}`, 'bot');
                }

                setShowCallbackForm(false);
                setCallbackData({ nom: '', telephone: '', email: '', probleme: '', vehicule: '' });
            };

            const getLevelName = () => {
                const names = {
                    0: 'Diagnostic de Base',
                    1: 'Diagnostic Avanc√©', 
                    2: 'Expertise Premium',
                    3: 'Service VIP'
                };
                return names[userLevel] || 'Inconnu';
            };

            const getAiModeDisplay = () => {
                return aiMode || 'ü§ñ IA';
            };

            const renderMessage = (message, index) => {
                const isUser = message.type === 'user';
                const sourceIcons = {
                    'üß† Dual Brain (Claude + OpenAI)': 'üß†',
                    'üéØ Claude Expert': 'üéØ',
                    'ü§ñ OpenAI Enhanced': 'ü§ñ',
                    'üì∏ Vision IA': 'üì∏',
                    'dual_brain_success': '‚úÖ',
                    'upgrade_success': 'üéÅ',
                    'intro': 'üëã'
                };
                
                const sourceIcon = sourceIcons[message.source] || '';
                
                return (
                    <div key={index} className={`mb-4 ${isUser ? 'text-right' : ''}`}>
                        <div className={`inline-block p-3 rounded-lg max-w-[85%] sm:max-w-md ${
                            isUser 
                                ? 'bg-blue-500 text-white' 
                                : message.source?.includes('Dual Brain') || message.source?.includes('üß†')
                                    ? 'bg-purple-100 text-gray-800 border-l-4 border-purple-500'
                                    : message.source?.includes('Claude') || message.source?.includes('üéØ')
                                        ? 'bg-blue-100 text-gray-800 border-l-4 border-blue-500'
                                        : message.source?.includes('OpenAI') || message.source?.includes('ü§ñ')
                                            ? 'bg-green-100 text-gray-800 border-l-4 border-green-500'
                                            : message.source?.includes('üì∏')
                                                ? 'bg-orange-100 text-gray-800 border-l-4 border-orange-500'
                                                : 'bg-white text-gray-800 border border-gray-200'
                        }`}>
                            {typeof message.content === 'string' ? 
                                message.content.split('\n').map((line, i) => (
                                    <div key={i} className={line.startsWith('**') && line.endsWith('**') ? 'font-bold' : ''}>
                                        {line.replace(/\*\*/g, '')}
                                    </div>
                                )) : 
                                <div>Erreur affichage message</div>
                            }
                            
                            {!isUser && (
                                <div className="text-xs text-gray-400 mt-2 flex items-center justify-between">
                                    <span>
                                        {sourceIcon} {message.source || 'Auto'} 
                                    </span>
                                    <span>{new Date(message.timestamp).toLocaleTimeString()}</span>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-orange-50">
                    {/* Header avec stats Dual Brain */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-6xl mx-auto px-2 sm:px-4 py-3">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center min-w-0 flex-1">
                                    <div className="mr-2 sm:mr-3 bg-gradient-to-r from-green-500 to-green-600 px-2 sm:px-4 py-1 sm:py-2 rounded-lg shadow-sm">
                                        <span className="text-white font-bold text-sm sm:text-lg">re-fap</span>
                                    </div>
                                    <div className="min-w-0 flex-1">
                                        <h1 className="text-sm sm:text-lg font-bold text-gray-800 truncate">Julien - Expert FAP Dual Brain</h1>
                                        <p className="text-xs text-gray-600 hidden sm:block">
                                            {getAiModeDisplay()} ‚Ä¢ {getLevelName()} ‚Ä¢ {leadValue}‚Ç¨ lead
                                        </p>
                                    </div>
                                </div>
                                <button 
                                    onClick={() => window.open('https://re-fap.fr/trouver_garage_partenaire/', '_blank')}
                                    className="bg-orange-500 hover:bg-orange-600 text-white px-2 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-medium transition-colors ml-2 whitespace-nowrap"
                                >
                                    <span className="hidden sm:inline">üìû Devis gratuit</span>
                                    <span className="sm:hidden">üìû</span>
                                </button>
                            </div>
                        </div>
                        
                        {/* Status Dual Brain */}
                        <div className="text-xs text-center py-2 bg-gradient-to-r from-purple-50 to-blue-50">
                            <span className="text-purple-600 font-medium">
                                üß† {getAiModeDisplay()} ‚Ä¢ Level {userLevel} ‚Ä¢ {leadData.interactions} interactions ‚Ä¢ {leadValue > 0 ? `${leadValue}‚Ç¨ lead` : 'Lead en cours'}
                            </span>
                        </div>
                    </header>

                    {/* Chat principal */}
                    <div className="max-w-6xl mx-auto p-2 sm:p-4">
                        <div className="flex flex-col lg:flex-row gap-2 sm:gap-4">
                            {/* Chat */}
                            <div className="flex-1 bg-white rounded-xl shadow-lg overflow-hidden">
                                {/* Header chat */}
                                <div className="bg-gradient-to-r from-orange-600 to-red-600 text-white p-4">
                                    <div className="flex items-center">
                                        <div className="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                                            <span className="text-2xl">üß†</span>
                                        </div>
                                        <div>
                                            <h2 className="text-xl font-bold">Julien Dual Brain IA</h2>
                                            <p className="text-orange-100 text-sm">
                                                Claude + OpenAI ‚Ä¢ {getLevelName()}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                {/* Messages */}
                                <div className="h-96 overflow-y-auto p-2 sm:p-4 bg-gray-50">
                                    {messages.map((message, index) => renderMessage(message, index))}
                                    
                                    {isTyping && (
                                        <div className="mb-4">
                                            <div className="inline-block bg-white p-3 rounded-lg border border-gray-200">
                                                <div className="flex items-center space-x-2">
                                                    <div className="flex space-x-1">
                                                        <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce"></div>
                                                        <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                                                        <div className="w-2 h-2 bg-orange-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                                    </div>
                                                    <span className="text-sm text-gray-600">Dual Brain analyse... üß†üíé</span>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>

                                {/* Input */}
                                <div className="p-2 sm:p-4 border-t bg-white">
                                    <form onSubmit={handleSendMessage} className="flex gap-2 mb-3">
                                        <input
                                            type="text"
                                            value={inputMessage}
                                            onChange={(e) => setInputMessage(e.target.value)}
                                            placeholder="üí¨ D√©cris ton probl√®me ou √©cris ton email..."
                                            className="flex-1 p-2 sm:p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-orange-500 text-sm"
                                            disabled={isTyping}
                                        />
                                        <button
                                            type="submit"
                                            disabled={isTyping || !inputMessage.trim()}
                                            className="bg-orange-500 hover:bg-orange-600 disabled:bg-gray-300 text-white px-3 sm:px-6 py-2 sm:py-3 rounded-lg font-medium transition-colors text-sm whitespace-nowrap"
                                        >
                                            <span className="hidden sm:inline">Envoyer</span>
                                            <span className="sm:hidden">üì§</span>
                                        </button>
                                    </form>

                                    {/* Upload photo */}
                                    <div className="mb-3 p-2 sm:p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border-2 border-dashed border-blue-300">
                                        <div className="text-center">
                                            <input
                                                type="file"
                                                id="imageUpload"
                                                accept="image/*"
                                                onChange={handleImageUpload}
                                                className="hidden"
                                                disabled={isTyping}
                                            />
                                            <label 
                                                htmlFor="imageUpload" 
                                                className="cursor-pointer bg-blue-500 hover:bg-blue-600 text-white px-3 sm:px-6 py-2 sm:py-3 rounded-lg inline-flex items-center gap-2 font-medium transition-colors text-sm"
                                            >
                                                üì∏ <span className="hidden sm:inline">Photo de mon voyant</span><span className="sm:hidden">Photo</span>
                                            </label>
                                            <p className="text-xs text-gray-600 mt-2 px-2">
                                                JPG/PNG max 5MB ‚Ä¢ Analyse Dual Brain ! üß†
                                            </p>
                                        </div>
                                    </div>

                                    {/* Quick options */}
                                    <div className="grid grid-cols-2 gap-1 sm:gap-2 mb-4 lg:mb-0">
                                        {[
                                            { text: "üü° Voyant FAP", textMobile: "üü° FAP", msg: "Voyant FAP allum√©" },
                                            { text: "üí® √áa fume", textMobile: "üí® Fume", msg: "√áa pue et √ßa fume" },
                                            { text: "‚ö° Perte puissance", textMobile: "‚ö° Puissance", msg: "Plus de puissance en ville" },
                                            { text: "üîß Je suis bricoleur", textMobile: "üîß Bricoleur", msg: "Je d√©monte moi-m√™me" }
                                        ].map((option, index) => (
                                            <button
                                                key={index}
                                                onClick={async () => {
                                                    addMessage(option.msg, 'user');
                                                    setIsTyping(true);
                                                    const response = await getDualBrainResponse(option.msg);
                                                    addMessage(response.text, 'bot', response.mode);
                                                    setIsTyping(false);
                                                }}
                                                disabled={isTyping}
                                                className="bg-gray-100 hover:bg-gray-200 p-2 rounded text-xs sm:text-sm disabled:opacity-50 transition-colors"
                                            >
                                                <span className="hidden sm:inline">{option.text}</span>
                                                <span className="sm:hidden">{option.textMobile}</span>
                                            </button>
                                        ))}
                                    </div>

                                    {/* CTA mobile */}
                                    <div className="lg:hidden p-3 bg-gradient-to-r from-orange-50 to-red-50 rounded-lg border border-orange-200">
                                        <h4 className="font-bold text-orange-800 text-sm mb-2 text-center">üéØ Besoin d'aide ?</h4>
                                        <div className="grid grid-cols-1 gap-2">
                                            <button
                                                onClick={handleGarageClick}
                                                className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded text-sm font-medium transition-colors"
                                            >
                                                üè™ Trouver un garage de confiance
                                            </button>
                                            <button
                                                onClick={handleCallbackClick}
                                                className="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded text-sm font-medium transition-colors"
                                            >
                                                üìû √ätre rappel√© gratuitement (Lead {leadValue}‚Ç¨)
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* CTA Section - DESKTOP */}
                            <div className="hidden lg:block w-64 space-y-4">
                                {/* Stats Dual Brain */}
                                <div className="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-3 text-center">
                                    <h4 className="font-bold text-purple-800 text-sm mb-1">üß† Dual Brain Stats</h4>
                                    <div className="text-xs text-purple-600 space-y-1">
                                        <div>Level: {getLevelName()}</div>
                                        <div>Mode: {getAiModeDisplay()}</div>
                                        <div>Lead: {leadValue}‚Ç¨</div>
                                        <div>Interactions: {leadData.interactions}</div>
                                    </div>
                                </div>

                                {/* Upgrade si niveau 0 */}
                                {userLevel === 0 && conversionStrategy && (
                                    <button
                                        onClick={handleUpgradeClick}
                                        className="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg font-medium transition-colors shadow-md hover:shadow-lg"
                                    >
                                        <div className="text-center">
                                            <div className="text-2xl mb-2">üîì</div>
                                            <div className="font-bold">Diagnostic Premium</div>
                                            <div className="font-bold">GRATUIT</div>
                                            <div className="text-xs mt-1 opacity-90">Dual Brain activ√© !</div>
                                        </div>
                                    </button>
                                )}

                                {/* Bouton Garage */}
                                <button
                                    onClick={handleGarageClick}
                                    className="w-full bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg font-medium transition-colors shadow-md hover:shadow-lg"
                                >
                                    <div className="text-center">
                                        <div className="text-2xl mb-2">üè™</div>
                                        <div className="font-bold">Trouver un garage</div>
                                        <div className="font-bold">de confiance</div>
                                        <div className="text-xs mt-1 opacity-90">R√©seau Re-Fap</div>
                                    </div>
                                </button>

                                {/* Bouton Rappel */}
                                <button
                                    onClick={handleCallbackClick}
                                    className="w-full bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg font-medium transition-colors shadow-md hover:shadow-lg"
                                >
                                    <div className="text-center">
                                        <div className="text-2xl mb-2">üìû</div>
                                        <div className="font-bold">√ätre rappel√©</div>
                                        <div className="font-bold">gratuitement</div>
                                        <div className="text-xs mt-1 opacity-90">Lead {leadValue}‚Ç¨ ‚Ä¢ Expert sous 2h</div>
                                    </div>
                                </button>
                            </div>
                        </div>

                        {/* MODAL UPGRADE PREMIUM */}
                        {showUpgradeForm && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-screen overflow-y-auto mx-2">
                                    <div className="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-3 sm:p-4 rounded-t-xl">
                                        <div className="flex items-center justify-between">
                                            <div className="flex-1">
                                                <h3 className="text-base sm:text-lg font-bold">üîì Diagnostic Premium Gratuit</h3>
                                                <p className="text-xs sm:text-sm opacity-90">Dual Brain Claude + OpenAI</p>
                                            </div>
                                            <button 
                                                onClick={() => setShowUpgradeForm(false)}
                                                className="text-white hover:bg-white hover:bg-opacity-20 p-1 rounded ml-2"
                                            >
                                                ‚úï
                                            </button>
                                        </div>
                                    </div>

                                    <form onSubmit={handleUpgradeSubmit} className="p-4 sm:p-6 space-y-4">
                                        <div className="text-center mb-4">
                                            <div className="text-2xl mb-2">üß†</div>
                                            <p className="text-sm text-gray-600">
                                                D√©bloquez l'analyse Dual Brain premium ! Fusion Claude (pr√©cision) + OpenAI (cr√©ativit√©) pour un diagnostic unique.
                                            </p>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Email *
                                            </label>
                                            <input
                                                type="email"
                                                required
                                                value={callbackData.email}
                                                onChange={(e) => setCallbackData({...callbackData, email: e.target.value})}
                                                className="w-full p-2 sm:p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 text-sm"
                                                placeholder="votre@email.com"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Pr√©nom
                                            </label>
                                            <input
                                                type="text"
                                                value={callbackData.nom}
                                                onChange={(e) => setCallbackData({...callbackData, nom: e.target.value})}
                                                className="w-full p-2 sm:p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 text-sm"
                                                placeholder="Votre pr√©nom"
                                            />
                                        </div>

                                        <div className="bg-purple-50 p-2 sm:p-3 rounded-lg text-xs text-purple-700">
                                            üéÅ <strong>Vous obtenez :</strong>
                                            <br />‚Ä¢ Analyse Dual Brain (Claude + OpenAI)
                                            <br />‚Ä¢ Diagnostic technique approfondi
                                            <br />‚Ä¢ Recommandations personnalis√©es
                                            <br />‚Ä¢ Estimation co√ªts pr√©cise
                                        </div>

                                        <div className="flex flex-col sm:flex-row gap-2 sm:gap-3">
                                            <button
                                                type="button"
                                                onClick={() => setShowUpgradeForm(false)}
                                                className="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 sm:py-3 px-4 rounded-lg font-medium transition-colors text-sm"
                                            >
                                                Plus tard
                                            </button>
                                            <button
                                                type="submit"
                                                className="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 sm:py-3 px-4 rounded-lg font-medium transition-colors text-sm"
                                            >
                                                üîì Activer Premium
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}

                        {/* MODAL RAPPEL */}
                        {showCallbackForm && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-screen overflow-y-auto mx-2">
                                    <div className="bg-gradient-to-r from-green-500 to-green-600 text-white p-3 sm:p-4 rounded-t-xl">
                                        <div className="flex items-center justify-between">
                                            <div className="flex-1">
                                                <h3 className="text-base sm:text-lg font-bold">üìû Rappel Expert</h3>
                                                <p className="text-xs sm:text-sm opacity-90">Lead {leadValue}‚Ç¨ ‚Ä¢ Dual Brain</p>
                                            </div>
                                            <button 
                                                onClick={() => setShowCallbackForm(false)}
                                                className="text-white hover:bg-white hover:bg-opacity-20 p-1 rounded ml-2"
                                            >
                                                ‚úï
                                            </button>
                                        </div>
                                    </div>

                                    <form onSubmit={handleCallbackSubmit} className="p-4 sm:p-6 space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Nom / Pr√©nom *
                                            </label>
                                            <input
                                                type="text"
                                                required
                                                value={callbackData.nom}
                                                onChange={(e) => setCallbackData({...callbackData, nom: e.target.value})}
                                                className="w-full p-2 sm:p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500 text-sm"
                                                placeholder="Votre nom complet"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                T√©l√©phone *
                                            </label>
                                            <input
                                                type="tel"
                                                required
                                                value={callbackData.telephone}
                                                onChange={(e) => setCallbackData({...callbackData, telephone: e.target.value})}
                                                className="w-full p-2 sm:p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500 text-sm"
                                                placeholder="06 12 34 56 78"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                Email
                                            </label>
                                            <input
                                                type="email"
                                                value={callbackData.email}
                                                onChange={(e) => setCallbackData({...callbackData, email: e.target.value})}
                                                className="w-full p-2 sm:p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500 text-sm"
                                                placeholder="votre@email.com"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                R√©sum√© du probl√®me
                                            </label>
                                            <textarea
                                                value={callbackData.probleme}
                                                onChange={(e) => setCallbackData({...callbackData, probleme: e.target.value})}
                                                className="w-full p-2 sm:p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500 text-sm"
                                                placeholder="Voyants allum√©s, fum√©es..."
                                                rows="3"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                V√©hicule
                                            </label>
                                            <input
                                                type="text"
                                                value={callbackData.vehicule}
                                                onChange={(e) => setCallbackData({...callbackData, vehicule: e.target.value})}
                                                className="w-full p-2 sm:p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500 text-sm"
                                                placeholder="Peugeot 308 2018"
                                            />
                                        </div>

                                        <div className="bg-green-50 p-2 sm:p-3 rounded-lg text-xs text-green-700">
                                            üß† <strong>Lead Dual Brain :</strong> {leadValue}‚Ç¨
                                            <br />üìä Analys√© par IA premium (Claude + OpenAI)
                                            <br />‚úÖ Donn√©es utilis√©es uniquement pour le rappel
                                        </div>

                                        <div className="flex flex-col sm:flex-row gap-2 sm:gap-3">
                                            <button
                                                type="button"
                                                onClick={() => setShowCallbackForm(false)}
                                                className="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 sm:py-3 px-4 rounded-lg font-medium transition-colors text-sm"
                                            >
                                                Annuler
                                            </button>
                                            <button
                                                type="submit"
                                                className="w-full bg-green-500 hover:bg-green-600 text-white py-2 sm:py-3 px-4 rounded-lg font-medium transition-colors text-sm"
                                            >
                                                üìû Demander le rappel
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <footer className="max-w-6xl mx-auto px-2 sm:px-4 py-4 sm:py-6 text-center text-xs sm:text-sm text-gray-600">
                        <div className="flex flex-wrap items-center justify-center gap-2 sm:gap-6 mb-3">
                            <span className="flex items-center"><span className="text-purple-500 mr-1">üß†</span> Dual Brain IA</span>
                            <span className="flex items-center"><span className="text-blue-500 mr-1">üéØ</span> {getLevelName()}</span>
                            <span className="flex items-center"><span className="text-green-500 mr-1">üí∞</span> {leadValue}‚Ç¨ lead</span>
                            <span className="flex items-center"><span className="text-orange-500 mr-1">üìä</span> {leadData.interactions} interactions</span>
                        </div>
                        <p className="text-xs px-2">
                            Powered by <a href="https://re-fap.fr" className="text-orange-600 hover:underline">Re-Fap</a> ‚Ä¢ 
                            Dual Brain IA (Claude + OpenAI) ‚Ä¢
                            <span className="hidden sm:inline"> Diagnostic premium ‚Ä¢</span>
                            <span className="block sm:inline"> Session: {leadData.sessionId}</span>
                        </p>
                    </footer>
                </div>
            );
        };

        ReactDOM.render(<JulienDualBrainChatbot />, document.getElementById('root'));
    </script>
</body>
</html>
