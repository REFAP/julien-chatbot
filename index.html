<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julien - Expert FAP Re-Fap v3.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 1600px;
            height: 98vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 10px 20px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }

        .expert-avatar {
            width: 40px;
            height: 40px;
            background: #fbbf24;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 auto 5px;
        }

        .expert-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .expert-title {
            opacity: 0.9;
            font-size: 12px;
        }

        .session-info {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            opacity: 0.8;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
            background: #f8fafc;
            min-height: 0;
            font-size: 13px;
        }

        .message {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin: 0 10px;
        }

        .message.user .message-avatar {
            background: #3b82f6;
            color: white;
        }

        .message.assistant .message-avatar {
            background: #fbbf24;
            color: #1f2937;
        }

        .message-content {
            max-width: 70%;
            background: white;
            border-radius: 18px;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #3b82f6;
            color: white;
        }

        .diagnostic-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            padding: 12px;
            margin: 8px 0;
            font-size: 13px;
        }

        .diagnostic-card h3, .diagnostic-card h4 {
            font-size: 14px;
            margin-bottom: 6px;
        }

        .diagnostic-card p, .diagnostic-card ul {
            font-size: 12px;
            margin: 4px 0;
        }

        .diagnostic-card ul {
            padding-left: 15px;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-indicator {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .cta-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .cta-button {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .cta-button:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
        }

        .cta-button.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .cta-button.secondary {
            background: #6b7280;
            color: white;
            border-color: #6b7280;
        }

        .cta-button.urgent {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            animation: pulse 2s infinite;
        }

        .cta-button.professional {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        .cta-button.prevention {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .cta-button.subscription {
            background: #f59e0b;
            color: white;
            border-color: #f59e0b;
        }

        .cta-button.success {
            background: #22c55e;
            color: white;
            border-color: #22c55e;
        }

        .cta-button.info {
            background: #06b6d4;
            color: white;
            border-color: #06b6d4;
        }

        .cta-button.warning {
            background: #f97316;
            color: white;
            border-color: #f97316;
        }

        .cta-button.alternative {
            background: #64748b;
            color: white;
            border-color: #64748b;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .workflow-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 10px;
            margin: 6px 0;
            border-left: 3px solid #10b981;
            font-size: 12px;
        }

        .workflow-steps {
            margin-top: 6px;
        }

        .workflow-step {
            display: flex;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 12px;
        }

        .step-number {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            margin-right: 8px;
        }

        .chat-input-container {
            padding: 10px 15px;
            background: white;
            border-top: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .current-question {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            padding: 8px;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 12px;
        }

        .current-question .question-label {
            color: #0369a1;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .chat-input {
            width: 100%;
            min-height: 40px;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 13px;
            resize: none;
            outline: none;
            transition: border-color 0.2s ease;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #3b82f6;
        }

        .input-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .send-button {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .send-button:hover {
            background: #2563eb;
        }

        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            color: #6b7280;
            font-style: italic;
            padding: 10px 0;
        }

        .error-message {
            background: #fecaca;
            border: 2px solid #ef4444;
            color: #991b1b;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .success-message {
            background: #bbf7d0;
            border: 2px solid #10b981;
            color: #065f46;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .question-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 6px;
            margin-top: 8px;
        }

        .option-button {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            font-size: 12px;
        }

        .option-button:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .collected-data-summary {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 11px;
        }

        .collected-data-summary h5 {
            color: #1e40af;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .collected-data-summary .data-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .collected-data-summary .data-label {
            color: #64748b;
        }

        .collected-data-summary .data-value {
            color: #1e293b;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                border-radius: 0;
                max-width: 100%;
            }
            
            .message-content {
                max-width: 92%;
                font-size: 12px;
            }
            
            .question-options {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 1400px) {
            .chat-container {
                max-width: 1800px;
            }
        }

        @media (min-width: 1900px) {
            .chat-container {
                max-width: 2000px;
            }
        }

        .demo-mode-indicator {
            background: #fbbf24;
            color: #1f2937;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            position: absolute;
            top: 10px;
            left: 10px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="demo-mode-indicator">Mode Démo</div>
            <div class="session-info" id="sessionInfo">Session: Nouvelle</div>
            <div class="expert-avatar">👨‍🔧</div>
            <div class="expert-name">Julien</div>
            <div class="expert-title">Expert FAP Re-Fap v3.0</div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                <div class="message-avatar">J</div>
                <div class="message-content">
                    <div class="diagnostic-card">
                        <h3>🔧 Bienvenue chez FAP Re-Fap Expert v3.0</h3>
                        <p>Je suis votre assistant intelligent pour diagnostiquer les problèmes de FAP (Filtre à Particules) avec précision.</p>
                        
                        <div class="progress-indicator">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>Diagnostic en cours</span>
                                <span id="progressText">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                            </div>
                        </div>
                        
                        <p><strong>💡 Comment ça marche :</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>🔍 Je collecte vos symptômes intelligemment</li>
                            <li>📊 J'analyse avec un moteur de scoring avancé</li>
                            <li>🎯 Je propose les solutions les plus efficaces</li>
                            <li>📈 J'apprends de chaque diagnostic pour m'améliorer</li>
                        </ul>
                        
                        <div class="cta-buttons">
                            <button class="cta-button primary" id="quickStartBtn">
                                🚀 Diagnostic rapide
                            </button>
                            <button class="cta-button" id="detailedStartBtn">
                                🔬 Analyse complète
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            Julien analyse votre message...
        </div>

        <div class="chat-input-container">
            <div class="current-question" id="currentQuestion" style="display: none;">
                <div class="question-label">Question en cours :</div>
                <div id="currentQuestionText"></div>
            </div>
            
            <textarea 
                class="chat-input" 
                id="messageInput" 
                placeholder="Décrivez votre problème FAP (voyants, perte puissance, fumée, codes erreur...)"
                rows="2"
            ></textarea>
            <div class="input-actions">
                <div style="display: flex; gap: 10px;">
                    <button class="cta-button" id="helpBtn">❓ Aide</button>
                    <button class="cta-button" id="resetBtn">🔄 Reset</button>
                </div>
                <button class="send-button" id="sendButton">
                    Envoyer
                </button>
            </div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://ipoxyhgfnzcggohugzzh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlwb3h5aGdmbnpjZ2dvaHVnenpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyMDU2OTksImV4cCI6MjA2OTc4MTY5OX0.PmS4a7jWFEGoUcxJiPSuNAByNAclW8vSz14UsgOANq0';
        
        // Initialisation Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        class FAPExpertChat {
            constructor() {
                this.sessionId = null;
                this.currentState = 'initial';
                this.messageHistory = [];
                this.currentProgress = 0;
                this.awaitingResponse = false;
                this.useDatabase = true;
                
                // NOUVEAU : Système de collecte de données amélioré
                this.collectedData = {
                    errorCode: null,
                    duration: null,
                    vehicleInfo: null,
                    symptoms: [],
                    drivingType: null,
                    mileage: null,
                    previousMaintenance: null,
                    lastRegeneration: null
                };
                this.questionSequence = 0;
                this.isCollectingData = false;
                this.currentQuestionContext = null;
                
                this.initializeEventListeners();
                this.generateSessionId();
                this.testDatabaseConnection();
            }

            async testDatabaseConnection() {
                try {
                    const { data, error } = await supabaseClient
                        .from('chat_sessions')
                        .select('count')
                        .limit(1);
                    
                    if (error) throw error;
                    console.log('✅ Connexion Supabase OK');
                    this.useDatabase = true;
                } catch (error) {
                    console.error('❌ Erreur Supabase:', error);
                    this.useDatabase = false;
                    this.displayMessage('assistant', 
                        "⚠️ Mode hors ligne activé. Les conversations ne seront pas sauvegardées.",
                        { ctas: [{ type: 'warning', title: '🔄 Réessayer', action: 'retry_connection' }] }
                    );
                }
            }

            initializeEventListeners() {
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendButton');

                if (messageInput) {
                    messageInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });

                    messageInput.addEventListener('input', () => {
                        messageInput.style.height = 'auto';
                        messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                    });
                }

                if (sendButton) {
                    sendButton.addEventListener('click', () => {
                        this.sendMessage();
                    });
                }
            }

            generateSessionId() {
                this.sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const sessionInfo = document.getElementById('sessionInfo');
                if (sessionInfo) {
                    sessionInfo.textContent = `Session: ${this.sessionId.split('_')[1]}`;
                }
                
                if (this.useDatabase) {
                    this.createDatabaseSession();
                }
            }

            async createDatabaseSession() {
                try {
                    const { data, error } = await supabaseClient
                        .from('chat_sessions')
                        .insert([{
                            session_id: this.sessionId,
                            created_at: new Date().toISOString(),
                            user_agent: navigator.userAgent,
                            status: 'active'
                        }])
                        .select();

                    if (error) {
                        console.error('Erreur création session:', error);
                    } else {
                        console.log('✅ Session créée dans Supabase');
                    }
                } catch (error) {
                    console.error('Erreur Supabase:', error);
                }
            }

            // NOUVELLE FONCTION : Obtenir la prochaine question
            getNextQuestion() {
                const questions = [
                    {
                        id: 'duration',
                        text: 'Depuis combien de temps observez-vous ce problème ?',
                        options: [
                            { label: '📅 Moins d\'une semaine', value: 'recent' },
                            { label: '📆 1-4 semaines', value: 'weeks' },
                            { label: '🗓️ Plus d\'un mois', value: 'old' }
                        ]
                    },
                    {
                        id: 'vehicle',
                        text: 'Quel est votre véhicule ? (marque, modèle, année)',
                        freeText: true,
                        placeholder: 'Ex: Audi A4 2.0 TDI 2018'
                    },
                    {
                        id: 'mileage',
                        text: 'Quel est le kilométrage de votre véhicule ?',
                        options: [
                            { label: '✅ Moins de 100 000 km', value: 'low' },
                            { label: '⚠️ 100-200 000 km', value: 'medium' },
                            { label: '🔴 Plus de 200 000 km', value: 'high' }
                        ]
                    },
                    {
                        id: 'driving',
                        text: 'Quel type de conduite faites-vous principalement ?',
                        options: [
                            { label: '🏙️ Ville (80%+)', value: 'city' },
                            { label: '🛣️ Autoroute (80%+)', value: 'highway' },
                            { label: '⚖️ Mixte 50/50', value: 'mixed' }
                        ]
                    },
                    {
                        id: 'symptoms',
                        text: 'Quels autres symptômes observez-vous ? (plusieurs choix possibles)',
                        multiSelect: true,
                        options: [
                            { label: '💨 Fumée à l\'échappement', value: 'smoke' },
                            { label: '⚡ Perte de puissance', value: 'power_loss' },
                            { label: '⛽ Surconsommation', value: 'consumption' },
                            { label: '🔊 Bruits anormaux', value: 'noise' },
                            { label: '🚗 Mode dégradé', value: 'limp_mode' },
                            { label: '✅ Aucun autre symptôme', value: 'none' }
                        ]
                    },
                    {
                        id: 'lastMaintenance',
                        text: 'Quand avez-vous fait votre dernière vidange ?',
                        options: [
                            { label: '📅 < 10 000 km', value: 'recent' },
                            { label: '📆 10-20 000 km', value: 'normal' },
                            { label: '🔴 > 20 000 km', value: 'overdue' },
                            { label: '❓ Je ne sais pas', value: 'unknown' }
                        ]
                    }
                ];
                
                return questions[this.questionSequence] || null;
            }

            // FONCTION MODIFIÉE : Gérer les réponses de manière plus intelligente
            async sendMessage(message = null) {
                const messageInput = document.getElementById('messageInput');
                const userMessage = message || messageInput.value.trim();
                
                if (!userMessage || this.awaitingResponse) return;

                this.setLoading(true);
                this.displayMessage('user', userMessage);
                
                if (messageInput) {
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                }

                try {
                    // Sauvegarder le message utilisateur
                    if (this.useDatabase) {
                        const { data: messageData, error: messageError } = await supabaseClient
                            .from('chat_messages')
                            .insert([{
                                session_id: this.sessionId,
                                sender: 'user',
                                content: userMessage,
                                created_at: new Date().toISOString()
                            }])
                            .select();

                        if (messageError) {
                            console.error('Erreur sauvegarde message:', messageError);
                        }
                    }

                    // Déterminer le type de réponse nécessaire
                    let response;
                    
                    // Si on est en mode collecte de données
                    if (this.isCollectingData && this.currentQuestionContext) {
                        response = await this.handleDataCollection(userMessage);
                    }
                    // Si c'est un code d'erreur, commencer la collecte
                    else if (this.isErrorCode(userMessage)) {
                        this.startDataCollection(userMessage);
                        response = await this.generateNextQuestion();
                    }
                    // Sinon, chercher dans la base ou générer une réponse
                    else {
                        if (this.useDatabase) {
                            const historicalResponse = await this.searchSimilarConversations(userMessage);
                            
                            if (historicalResponse && historicalResponse.confidence > 0.6) {
                                console.log('✅ Réponse pertinente trouvée dans l\'historique');
                                response = historicalResponse;
                            } else {
                                console.log('🔄 Génération de réponse contextuelle');
                                response = await this.generateLocalResponse(userMessage);
                            }
                        } else {
                            response = await this.generateLocalResponse(userMessage);
                        }
                    }
                    
                    // Sauvegarder la réponse enrichie
                    if (this.useDatabase && response.response) {
                        const enrichedMetadata = {
                            confidence: response.confidence,
                            top_causes: response.top_causes,
                            source: response.source || 'generated',
                            diagnostic_context: this.isCollectingData ? {
                                error_codes: this.collectedData.errorCode ? [this.collectedData.errorCode] : [],
                                symptoms: this.collectedData.symptoms,
                                vehicle_info: this.collectedData.vehicleInfo,
                                driving_type: this.collectedData.drivingType,
                                mileage_range: this.collectedData.mileage,
                                duration: this.collectedData.duration,
                                last_maintenance: this.collectedData.lastMaintenance
                            } : null,
                            solution_details: response.recommendedSolution || null,
                            question_sequence: this.questionSequence,
                            collected_data_complete: this.isDataCollectionComplete()
                        };

                        const { error: responseError } = await supabaseClient
                            .from('chat_messages')
                            .insert([{
                                session_id: this.sessionId,
                                sender: 'assistant',
                                content: response.response,
                                metadata: enrichedMetadata,
                                created_at: new Date().toISOString()
                            }]);

                        if (responseError) {
                            console.error('Erreur sauvegarde réponse:', responseError);
                        }
                    }

                    this.handleResponse(response);
                    
                } catch (error) {
                    console.error('Erreur:', error);
                    this.displayError('Une erreur est survenue. Mode hors ligne activé.');
                    this.useDatabase = false;
                } finally {
                    this.setLoading(false);
                }
            }

            // NOUVELLE FONCTION : Vérifier si c'est un code d'erreur
            isErrorCode(message) {
                const errorCodePattern = /p[0-9]{4}/i;
                return errorCodePattern.test(message);
            }

            // NOUVELLE FONCTION : Démarrer la collecte de données
            startDataCollection(message) {
                this.isCollectingData = true;
                this.questionSequence = 0;
                
                // Extraire le code d'erreur
                const errorCodeMatch = message.match(/p[0-9]{4}/i);
                if (errorCodeMatch) {
                    this.collectedData.errorCode = errorCodeMatch[0].toUpperCase();
                }
                
                console.log('🔄 Démarrage collecte de données pour:', this.collectedData.errorCode);
            }

            // NOUVELLE FONCTION : Gérer la collecte de données
            async handleDataCollection(userMessage) {
                const currentQuestion = this.currentQuestionContext;
                
                if (!currentQuestion) {
                    return this.generateNextQuestion();
                }
                
                // Stocker la réponse selon le type de question
                switch (currentQuestion.id) {
                    case 'duration':
                        const durationMap = {
                            'récent': 'recent', 'semaine': 'recent',
                            'semaines': 'weeks', 'mois': 'old'
                        };
                        this.collectedData.duration = this.findMatchingValue(userMessage, durationMap) || 'unknown';
                        break;
                        
                    case 'vehicle':
                        this.collectedData.vehicleInfo = this.extractVehicleInfo(userMessage);
                        break;
                        
                    case 'mileage':
                        const mileageMap = {
                            'moins': 'low', '100': 'medium', '200': 'high'
                        };
                        this.collectedData.mileage = this.findMatchingValue(userMessage, mileageMap) || 'medium';
                        break;
                        
                    case 'driving':
                        const drivingMap = {
                            'ville': 'city', 'autoroute': 'highway', 'mixte': 'mixed'
                        };
                        this.collectedData.drivingType = this.findMatchingValue(userMessage, drivingMap) || 'mixed';
                        break;
                        
                    case 'symptoms':
                        this.collectedData.symptoms = this.extractSymptoms(userMessage);
                        break;
                        
                    case 'lastMaintenance':
                        const maintenanceMap = {
                            'récent': 'recent', '10': 'recent', '20': 'normal', 'pas': 'overdue'
                        };
                        this.collectedData.lastMaintenance = this.findMatchingValue(userMessage, maintenanceMap) || 'unknown';
                        break;
                }
                
                // Passer à la question suivante
                this.questionSequence++;
                
                // Si on a fini les questions, générer le diagnostic final
                if (this.isDataCollectionComplete()) {
                    return this.generateFinalDiagnosis();
                } else {
                    return this.generateNextQuestion();
                }
            }

            // NOUVELLE FONCTION : Générer la prochaine question
            async generateNextQuestion() {
                const question = this.getNextQuestion();
                
                if (!question) {
                    return this.generateFinalDiagnosis();
                }
                
                this.currentQuestionContext = question;
                
                let response = {
                    success: true,
                    response: '',
                    confidence: 0.3 + (this.questionSequence * 0.1),
                    current_progress: 15 + (this.questionSequence * 12),
                    ctas: []
                };
                
                // Afficher un résumé des données collectées si on a déjà des infos
                if (this.questionSequence > 0) {
                    response.response = this.generateDataSummary() + '\n\n';
                }
                
                response.response += `**${question.text}**`;
                
                if (question.freeText) {
                    response.response += '\n\n💬 Entrez votre réponse ci-dessous.';
                    response.form_active = true;
                } else if (question.options) {
                    response.ctas = question.options.map(opt => ({
                        type: 'primary',
                        title: opt.label,
                        action: `answer_${question.id}_${opt.value}`
                    }));
                }
                
                return response;
            }

            // NOUVELLE FONCTION : Générer un résumé des données collectées
            generateDataSummary() {
                let summary = '📊 **Informations collectées :**\n';
                
                if (this.collectedData.errorCode) {
                    summary += `• Code erreur : ${this.collectedData.errorCode}\n`;
                }
                if (this.collectedData.duration) {
                    summary += `• Durée : ${this.formatDuration(this.collectedData.duration)}\n`;
                }
                if (this.collectedData.vehicleInfo?.make) {
                    summary += `• Véhicule : ${this.collectedData.vehicleInfo.make} ${this.collectedData.vehicleInfo.model || ''}\n`;
                }
                if (this.collectedData.mileage) {
                    summary += `• Kilométrage : ${this.formatMileage(this.collectedData.mileage)}\n`;
                }
                if (this.collectedData.drivingType) {
                    summary += `• Conduite : ${this.formatDrivingType(this.collectedData.drivingType)}\n`;
                }
                
                return summary;
            }

            // NOUVELLE FONCTION : Vérifier si la collecte est complète
            isDataCollectionComplete() {
                return this.questionSequence >= 6; // Nombre de questions à poser
            }

            // NOUVELLE FONCTION : Générer le diagnostic final enrichi
            async generateFinalDiagnosis() {
                this.isCollectingData = false;
                
                // D'abord chercher dans la base avec toutes les données collectées
                let historicalDiagnosis = null;
                if (this.useDatabase) {
                    historicalDiagnosis = await this.searchEnrichedDiagnosis();
                }
                
                let response = {
                    success: true,
                    response: '',
                    confidence: 0.85,
                    current_progress: 100,
                    ctas: []
                };
                
                // Construire le diagnostic personnalisé
                response.response = `🎯 **Diagnostic personnalisé pour votre ${this.collectedData.vehicleInfo?.make || 'véhicule'} ${this.collectedData.vehicleInfo?.model || ''}**\n\n`;
                
                // Analyse basée sur les données collectées
                const riskFactors = this.calculateRiskFactors();
                
                response.response += `**Analyse de votre situation :**\n`;
                response.response += `• Code ${this.collectedData.errorCode} détecté\n`;
                response.response += `• Problème présent depuis : ${this.formatDuration(this.collectedData.duration)}\n`;
                response.response += `• Type de conduite : ${this.formatDrivingType(this.collectedData.drivingType)}\n`;
                response.response += `• Kilométrage : ${this.formatMileage(this.collectedData.mileage)}\n\n`;
                
                // Niveau de risque
                response.response += `**Niveau de gravité : ${riskFactors.severity}/5** ${this.getSeverityEmoji(riskFactors.severity)}\n\n`;
                
                // Diagnostic spécifique
                if (historicalDiagnosis) {
                    response.response += `**Diagnostic basé sur ${historicalDiagnosis.similarCases} cas similaires :**\n`;
                    response.response += historicalDiagnosis.diagnosis + '\n\n';
                    response.confidence = historicalDiagnosis.confidence;
                } else {
                    response.response += this.generateDiagnosisFromRules(riskFactors) + '\n\n';
                }
                
                // Top causes avec probabilités ajustées
                response.top_causes = this.calculateTopCauses(riskFactors);
                
                // Solutions personnalisées
                response.response += '**Solutions recommandées par ordre de priorité :**\n\n';
                const solutions = this.generatePersonalizedSolutions(riskFactors);
                
                solutions.forEach((solution, index) => {
                    response.response += `**${index + 1}. ${solution.name}**\n`;
                    response.response += `• Coût estimé : ${solution.cost}\n`;
                    response.response += `• Taux de succès : ${solution.successRate}%\n`;
                    response.response += `• ${solution.description}\n\n`;
                });
                
                // CTAs personnalisés
                response.ctas = this.generatePersonalizedCTAs(riskFactors, solutions);
                
                // Recommandation spéciale conduite urbaine
                if (this.collectedData.drivingType === 'city') {
                    response.response += `\n💡 **Conseil spécial conduite urbaine :**\n`;
                    response.response += `Votre conduite principalement en ville favorise l'encrassement du FAP. `;
                    response.response += `Je recommande des trajets réguliers sur autoroute (30-45 min à 90-110 km/h) pour prévenir les problèmes futurs.\n`;
                }
                
                return response;
            }

            // NOUVELLE FONCTION : Recherche enrichie dans la base
            async searchEnrichedDiagnosis() {
                try {
                    // Construire la requête multi-critères
                    let query = supabaseClient
                        .from('chat_messages')
                        .select(`
                            *,
                            chat_sessions!inner(*)
                        `)
                        .eq('sender', 'assistant')
                        .not('metadata->diagnostic_context', 'is', null)
                        .eq('metadata->collected_data_complete', true);
                    
                    // Filtrer par code d'erreur si présent
                    if (this.collectedData.errorCode) {
                        query = query.contains('metadata->diagnostic_context->error_codes', [this.collectedData.errorCode]);
                    }
                    
                    const { data: matches, error } = await query.limit(20);
                    
                    if (error) throw error;
                    
                    if (!matches || matches.length === 0) return null;
                    
                    // Calculer la similarité pour chaque match
                    const scoredMatches = matches.map(match => {
                        const context = match.metadata?.diagnostic_context || {};
                        let score = 0;
                        let matchedCriteria = [];
                        
                        // Score pour code d'erreur
                        if (context.error_codes?.includes(this.collectedData.errorCode)) {
                            score += 0.3;
                            matchedCriteria.push('code_erreur');
                        }
                        
                        // Score pour type de conduite
                        if (context.driving_type === this.collectedData.drivingType) {
                            score += 0.2;
                            matchedCriteria.push('type_conduite');
                        }
                        
                        // Score pour kilométrage similaire
                        if (context.mileage_range === this.collectedData.mileage) {
                            score += 0.15;
                            matchedCriteria.push('kilometrage');
                        }
                        
                        // Score pour symptômes communs
                        if (context.symptoms && this.collectedData.symptoms.length > 0) {
                            const commonSymptoms = context.symptoms.filter(s => 
                                this.collectedData.symptoms.includes(s)
                            ).length;
                            const symptomScore = (commonSymptoms / this.collectedData.symptoms.length) * 0.25;
                            score += symptomScore;
                            if (symptomScore > 0) matchedCriteria.push('symptomes');
                        }
                        
                        // Score pour durée similaire
                        if (context.duration === this.collectedData.duration) {
                            score += 0.1;
                            matchedCriteria.push('duree');
                        }
                        
                        return {
                            ...match,
                            relevanceScore: score,
                            matchedCriteria
                        };
                    });
                    
                    // Filtrer et trier par score
                    const relevantMatches = scoredMatches
                        .filter(m => m.relevanceScore > 0.4)
                        .sort((a, b) => b.relevanceScore - a.relevanceScore);
                    
                    if (relevantMatches.length === 0) return null;
                    
                    // Analyser les solutions qui ont fonctionné
                    const successfulSolutions = relevantMatches
                        .filter(m => m.metadata?.solution_details?.success_reported)
                        .map(m => m.metadata.solution_details);
                    
                    return {
                        diagnosis: this.synthesizeDiagnosis(relevantMatches),
                        confidence: Math.min(relevantMatches[0].relevanceScore + 0.2, 0.95),
                        similarCases: relevantMatches.length,
                        successfulSolutions,
                        bestMatch: relevantMatches[0]
                    };
                    
                } catch (error) {
                    console.error('Erreur recherche enrichie:', error);
                    return null;
                }
            }

            // NOUVELLE FONCTION : Synthétiser un diagnostic à partir de plusieurs cas
            synthesizeDiagnosis(matches) {
                const topMatch = matches[0];
                const commonCauses = this.extractCommonCauses(matches);
                
                let synthesis = `D'après l'analyse de cas similaires, votre problème de FAP `;
                
                if (topMatch.relevanceScore > 0.7) {
                    synthesis += `correspond très précisément à un encrassement typique. `;
                } else {
                    synthesis += `présente des caractéristiques d'encrassement classique. `;
                }
                
                // Ajouter les causes les plus fréquentes
                if (commonCauses.length > 0) {
                    synthesis += `\n\nLes causes principales identifiées sont :\n`;
                    commonCauses.slice(0, 3).forEach((cause, idx) => {
                        synthesis += `${idx + 1}. ${cause.name} (${Math.round(cause.frequency * 100)}% des cas)\n`;
                    });
                }
                
                return synthesis;
            }

            // NOUVELLE FONCTION : Extraire les causes communes
            extractCommonCauses(matches) {
                const causesMap = new Map();
                
                matches.forEach(match => {
                    const causes = match.metadata?.top_causes || [];
                    causes.forEach(cause => {
                        const key = cause.name;
                        if (!causesMap.has(key)) {
                            causesMap.set(key, { name: cause.name, count: 0, totalScore: 0 });
                        }
                        const existing = causesMap.get(key);
                        existing.count++;
                        existing.totalScore += cause.score || 0;
                    });
                });
                
                return Array.from(causesMap.values())
                    .map(cause => ({
                        name: cause.name,
                        frequency: cause.count / matches.length,
                        averageScore: cause.totalScore / cause.count
                    }))
                    .sort((a, b) => b.frequency - a.frequency);
            }

            // NOUVELLE FONCTION : Calculer les facteurs de risque
            calculateRiskFactors() {
                let severity = 1; // Base
                let urgency = 'normal';
                let factors = [];
                
                // Facteur : durée du problème
                if (this.collectedData.duration === 'old') {
                    severity += 1;
                    factors.push('probleme_ancien');
                } else if (this.collectedData.duration === 'weeks') {
                    severity += 0.5;
                }
                
                // Facteur : kilométrage
                if (this.collectedData.mileage === 'high') {
                    severity += 0.5;
                    factors.push('kilometrage_eleve');
                }
                
                // Facteur : conduite urbaine
                if (this.collectedData.drivingType === 'city') {
                    severity += 1;
                    factors.push('conduite_urbaine');
                }
                
                // Facteur : symptômes multiples
                if (this.collectedData.symptoms.includes('power_loss')) {
                    severity += 1;
                    factors.push('perte_puissance');
                    urgency = 'high';
                }
                
                if (this.collectedData.symptoms.includes('limp_mode')) {
                    severity += 1.5;
                    factors.push('mode_degrade');
                    urgency = 'urgent';
                }
                
                // Facteur : maintenance en retard
                if (this.collectedData.lastMaintenance === 'overdue') {
                    severity += 0.5;
                    factors.push('maintenance_retard');
                }
                
                return {
                    severity: Math.min(Math.round(severity), 5),
                    urgency,
                    factors,
                    raw: severity
                };
            }

            // NOUVELLE FONCTION : Générer un diagnostic basé sur les règles
            generateDiagnosisFromRules(riskFactors) {
                let diagnosis = '';
                
                if (riskFactors.severity >= 4) {
                    diagnosis = `**⚠️ Situation critique détectée**\n\n`;
                    diagnosis += `Votre FAP présente un encrassement sévère avec risque de dommages au moteur. `;
                    diagnosis += `Une intervention rapide est nécessaire pour éviter des réparations coûteuses.\n`;
                } else if (riskFactors.severity >= 3) {
                    diagnosis = `**🟠 Encrassement important du FAP**\n\n`;
                    diagnosis += `Le filtre à particules est significativement obstrué. `;
                    diagnosis += `Sans intervention, la situation va s'aggraver rapidement.\n`;
                } else {
                    diagnosis = `**🟡 Début d'encrassement FAP**\n\n`;
                    diagnosis += `Le filtre commence à s'encrasser mais la situation est encore gérable. `;
                    diagnosis += `Une action préventive maintenant évitera des problèmes plus graves.\n`;
                }
                
                // Ajouter des détails spécifiques
                if (riskFactors.factors.includes('conduite_urbaine')) {
                    diagnosis += `\n• La conduite urbaine empêche les régénérations naturelles du FAP`;
                }
                if (riskFactors.factors.includes('perte_puissance')) {
                    diagnosis += `\n• La perte de puissance indique une contre-pression élevée`;
                }
                if (riskFactors.factors.includes('mode_degrade')) {
                    diagnosis += `\n• Le mode dégradé protège votre moteur mais limite les performances`;
                }
                
                return diagnosis;
            }

            // NOUVELLE FONCTION : Calculer les causes principales ajustées
            calculateTopCauses(riskFactors) {
                const causes = [
                    { 
                        name: 'FAP encrassé', 
                        baseScore: 0.6,
                        boost: riskFactors.factors.includes('conduite_urbaine') ? 0.2 : 0
                    },
                    { 
                        name: 'Régénération incomplète', 
                        baseScore: 0.2,
                        boost: riskFactors.factors.includes('conduite_urbaine') ? 0.15 : 0
                    },
                    { 
                        name: 'Capteur défaillant', 
                        baseScore: 0.1,
                        boost: riskFactors.duration === 'recent' ? 0.1 : 0
                    },
                    { 
                        name: 'Qualité carburant/huile', 
                        baseScore: 0.05,
                        boost: riskFactors.factors.includes('maintenance_retard') ? 0.1 : 0
                    },
                    { 
                        name: 'Vanne EGR encrassée', 
                        baseScore: 0.05,
                        boost: riskFactors.factors.includes('kilometrage_eleve') ? 0.05 : 0
                    }
                ];
                
                return causes
                    .map(cause => ({
                        name: cause.name,
                        score: Math.min(cause.baseScore + cause.boost, 1),
                        description: this.getCauseDescription(cause.name)
                    }))
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 3);
            }

            // NOUVELLE FONCTION : Générer des solutions personnalisées
            generatePersonalizedSolutions(riskFactors) {
                const solutions = [];
                
                if (riskFactors.severity >= 4) {
                    solutions.push({
                        name: 'Nettoyage professionnel urgent',
                        cost: '200-300€',
                        successRate: 85,
                        description: 'Nettoyage chimique avec produit Re-Fap en atelier spécialisé',
                        priority: 1
                    });
                } else if (riskFactors.severity >= 3) {
                    solutions.push({
                        name: 'Régénération forcée + Nettoyage',
                        cost: '150-250€',
                        successRate: 75,
                        description: 'Combinaison régénération électronique et traitement chimique',
                        priority: 1
                    });
                }
                
                // Solution préventive toujours proposée
                if (riskFactors.drivingType === 'city') {
                    solutions.push({
                        name: 'Programme prévention urbaine',
                        cost: '50-100€',
                        successRate: 90,
                        description: 'Additif préventif + conseils de conduite adaptés',
                        priority: 2
                    });
                }
                
                // Régénération autoroute si pas trop grave
                if (riskFactors.severity <= 3) {
                    solutions.push({
                        name: 'Régénération autoroute',
                        cost: '20€ (carburant)',
                        successRate: 60,
                        description: '45 min à 90-110 km/h, régime > 2500 tr/min',
                        priority: 3
                    });
                }
                
                // Solution définitive si très grave
                if (riskFactors.severity >= 4 && riskFactors.factors.includes('kilometrage_eleve')) {
                    solutions.push({
                        name: 'Remplacement FAP',
                        cost: '800-1500€',
                        successRate: 100,
                        description: 'Solution définitive si nettoyage inefficace',
                        priority: 4
                    });
                }
                
                return solutions;
            }

            // NOUVELLE FONCTION : Générer des CTAs personnalisés
            generatePersonalizedCTAs(riskFactors, solutions) {
                const ctas = [];
                
                if (riskFactors.urgency === 'urgent') {
                    ctas.push({
                        type: 'urgent',
                        title: '🚨 Intervention urgente',
                        action: 'book_urgent_appointment',
                        description: 'Réserver sous 48h'
                    });
                }
                
                // CTA principal basé sur la première solution
                if (solutions[0]) {
                    ctas.push({
                        type: 'primary',
                        title: `🔧 ${solutions[0].name}`,
                        action: 'book_primary_solution',
                        description: `${solutions[0].successRate}% de succès`
                    });
                }
                
                // Toujours proposer un devis
                ctas.push({
                    type: 'professional',
                    title: '📋 Devis personnalisé',
                    action: 'get_personalized_quote',
                    description: 'Gratuit et sans engagement'
                });
                
                // Prévention si conduite urbaine
                if (this.collectedData.drivingType === 'city') {
                    ctas.push({
                        type: 'prevention',
                        title: '🛡️ Pack prévention urbain',
                        action: 'urban_prevention_pack'
                    });
                }
                
                // Contact expert
                ctas.push({
                    type: 'info',
                    title: '💬 Parler à un expert',
                    action: 'contact_expert'
                });
                
                return ctas;
            }

            // Fonctions utilitaires de formatage
            formatDuration(duration) {
                const formats = {
                    'recent': 'moins d\'une semaine',
                    'weeks': '1-4 semaines',
                    'old': 'plus d\'un mois',
                    'unknown': 'durée inconnue'
                };
                return formats[duration] || duration;
            }

            formatMileage(mileage) {
                const formats = {
                    'low': '< 100 000 km',
                    'medium': '100-200 000 km',
                    'high': '> 200 000 km',
                    'unknown': 'non précisé'
                };
                return formats[mileage] || mileage;
            }

            formatDrivingType(type) {
                const formats = {
                    'city': 'principalement urbaine',
                    'highway': 'principalement autoroute',
                    'mixed': 'mixte ville/route'
                };
                return formats[type] || type;
            }

            getSeverityEmoji(severity) {
                const emojis = ['', '🟢', '🟡', '🟠', '🔴', '🚨'];
                return emojis[severity] || '';
            }

            getCauseDescription(causeName) {
                const descriptions = {
                    'FAP encrassé': 'Accumulation de suie dans le filtre',
                    'Régénération incomplète': 'Cycles de nettoyage interrompus',
                    'Capteur défaillant': 'Capteur de pression ou température HS',
                    'Qualité carburant/huile': 'Carburant ou huile inadaptés',
                    'Vanne EGR encrassée': 'Recirculation des gaz perturbée'
                };
                return descriptions[causeName] || '';
            }

            findMatchingValue(text, valueMap) {
                const lowerText = text.toLowerCase();
                for (const [key, value] of Object.entries(valueMap)) {
                    if (lowerText.includes(key)) {
                        return value;
                    }
                }
                return null;
            }

            extractSymptoms(text) {
                const symptoms = [];
                const lowerText = text.toLowerCase();
                
                const symptomMap = {
                    'fumée': 'smoke',
                    'fumee': 'smoke',
                    'puissance': 'power_loss',
                    'perte': 'power_loss',
                    'consommation': 'consumption',
                    'surconsommation': 'consumption',
                    'bruit': 'noise',
                    'mode': 'limp_mode',
                    'dégradé': 'limp_mode',
                    'degrade': 'limp_mode',
                    'aucun': 'none',
                    'non': 'none'
                };
                
                for (const [key, value] of Object.entries(symptomMap)) {
                    if (lowerText.includes(key) && !symptoms.includes(value)) {
                        symptoms.push(value);
                    }
                }
                
                return symptoms.length > 0 ? symptoms : ['none'];
            }

            // FONCTION AMÉLIORÉE : searchSimilarConversations
            async searchSimilarConversations(userMessage) {
                try {
                    const lowerMessage = userMessage.toLowerCase();
                    const keywords = this.extractKeywords(lowerMessage);
                    
                    console.log('🔍 Recherche avec mots-clés:', keywords);
                    
                    let results = [];
                    
                    // 1. Recherche exacte d'abord
                    const { data: exactMatches } = await supabaseClient
                        .from('chat_messages')
                        .select('*')
                        .eq('sender', 'user')
                        .ilike('content', `%${lowerMessage}%`)
                        .limit(5);
                    
                    if (exactMatches && exactMatches.length > 0) {
                        results = exactMatches;
                        console.log(`✅ ${exactMatches.length} correspondances exactes trouvées`);
                    }
                    
                    // 2. Si pas de résultats exacts, recherche par mots-clés
                    if (results.length === 0 && keywords.length > 0) {
                        for (const keyword of keywords) {
                            const { data: keywordMatches } = await supabaseClient
                                .from('chat_messages')
                                .select('*')
                                .eq('sender', 'user')
                                .ilike('content', `%${keyword}%`)
                                .limit(10);
                            
                            if (keywordMatches) {
                                results = [...results, ...keywordMatches];
                            }
                        }
                        
                        // Dédupliquer les résultats
                        results = Array.from(new Map(results.map(item => [item.id, item])).values());
                        console.log(`✅ ${results.length} correspondances par mots-clés`);
                    }
                    
                    // 3. Recherche par métadonnées si disponibles
                    if (results.length === 0) {
                        const vehicleInfo = this.extractVehicleInfo(lowerMessage);
                        if (vehicleInfo.make || vehicleInfo.model) {
                            const { data: metadataMatches } = await supabaseClient
                                .from('chat_messages')
                                .select('*')
                                .eq('sender', 'assistant')
                                .or(`metadata->vehicle.ilike.%${vehicleInfo.make}%,metadata->vehicle.ilike.%${vehicleInfo.model}%`)
                                .limit(10);
                            
                            if (metadataMatches && metadataMatches.length > 0) {
                                for (const match of metadataMatches) {
                                    const { data: userMsg } = await supabaseClient
                                        .from('chat_messages')
                                        .select('*')
                                        .eq('session_id', match.session_id)
                                        .eq('sender', 'user')
                                        .single();
                                    
                                    if (userMsg) {
                                        results.push(userMsg);
                                    }
                                }
                                console.log(`✅ ${results.length} correspondances par véhicule`);
                            }
                        }
                    }
                    
                    if (results.length === 0) {
                        console.log('❌ Aucune correspondance trouvée');
                        return null;
                    }
                    
                    // Calculer la similarité et trouver la meilleure correspondance
                    let bestMatch = null;
                    let bestScore = 0;
                    
                    for (const msg of results) {
                        const score = this.calculateSimilarity(lowerMessage, msg.content.toLowerCase());
                        if (score > bestScore) {
                            bestScore = score;
                            bestMatch = msg;
                        }
                    }
                    
                    // Seuil de similarité plus bas pour accepter plus de résultats
                    if (!bestMatch || bestScore < 0.3) {
                        return null;
                    }
                    
                    console.log(`✅ Meilleure correspondance (score: ${bestScore.toFixed(2)}):`, bestMatch.content);
                    
                    // Récupérer la réponse associée
                    const { data: assistantResponse } = await supabaseClient
                        .from('chat_messages')
                        .select('*')
                        .eq('session_id', bestMatch.session_id)
                        .eq('sender', 'assistant')
                        .order('created_at', { ascending: true })
                        .limit(1);
                    
                    if (!assistantResponse || assistantResponse.length === 0) {
                        return null;
                    }
                    
                    const response = assistantResponse[0];
                    return {
                        success: true,
                        response: this.adaptResponse(response.content, bestScore),
                        confidence: Math.min(bestScore + 0.2, 0.95),
                        source: 'database',
                        original_question: bestMatch.content,
                        similarity_score: bestScore,
                        needs_clarification: bestScore < 0.5,
                        ...response.metadata
                    };
                    
                } catch (error) {
                    console.error('Erreur recherche:', error);
                    return null;
                }

