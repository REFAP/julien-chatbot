// api/analyze-image.js
// Vercel Function pour analyser les photos avec Claude Vision

export default async function handler(request, response) {
    // Autoriser CORS
    response.setHeader('Access-Control-Allow-Origin', '*');
    response.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    response.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    // G√©rer les requ√™tes OPTIONS (preflight)
    if (request.method === 'OPTIONS') {
        return response.status(200).end();
    }

    // Seules les requ√™tes POST sont autoris√©es
    if (request.method !== 'POST') {
        return response.status(405).json({ 
            error: 'M√©thode non autoris√©e. Utilisez POST.' 
        });
    }

    try {
        // R√©cup√©rer les donn√©es de la requ√™te
        const { image, conversation, prompt } = request.body;

        // R√©cup√©rer la cl√© API depuis les variables d'environnement
        const CLAUDE_API_KEY = process.env.CLAUDE_API_KEY;
        
        if (!CLAUDE_API_KEY) {
            console.error('‚ùå Cl√© API Claude manquante');
            return response.status(500).json({ 
                error: 'Configuration API manquante',
                fallback: generateFallbackAnalysis()
            });
        }

        let messageContent = [];
        
        // Si c'est une conversation (pas d'image)
        if (conversation && Array.isArray(conversation)) {
            // Mode dialogue pur - Claude fait tout
            const claudeResponse = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'x-api-key': CLAUDE_API_KEY,
                    'Content-Type': 'application/json',
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: "claude-3-5-sonnet-20241022",
                    max_tokens: 300,
                    system: prompt,
                    messages: conversation
                })
            });

            if (!claudeResponse.ok) {
                const errorData = await claudeResponse.text();
                console.error('‚ùå Erreur Claude Conversation:', claudeResponse.status, errorData);
                
                return response.status(500).json({
                    error: `Erreur Claude Conversation: ${claudeResponse.status}`,
                    fallback: generateFallbackAnalysis()
                });
            }

            const claudeData = await claudeResponse.json();
            
            console.log('‚úÖ Dialogue Claude r√©ussi:', {
                timestamp: new Date().toISOString(),
                tokensUsed: claudeData.usage?.input_tokens + claudeData.usage?.output_tokens
            });

            return response.status(200).json({
                success: true,
                analysis: claudeData.content[0].text,
                metadata: {
                    timestamp: new Date().toISOString(),
                    model: 'claude-3-5-sonnet',
                    type: 'conversation',
                    tokensUsed: claudeData.usage?.input_tokens + claudeData.usage?.output_tokens
                }
            });
        }
        
        // Mode analyse d'image (code existant)
        if (!image) {
            return response.status(400).json({ 
                error: 'Image ou conversation manquante' 
            });
        }

        // Pr√©parer l'image (retirer le pr√©fixe data:image)
        let imageData;
        let mediaType = 'image/jpeg';
        
        if (image.startsWith('data:image/')) {
            const [header, base64Data] = image.split(',');
            imageData = base64Data;
            
            // D√©tecter le type d'image
            if (header.includes('png')) mediaType = 'image/png';
            else if (header.includes('jpeg') || header.includes('jpg')) mediaType = 'image/jpeg';
        } else {
            imageData = image;
        }

        messageContent = [
            {
                type: "text",
                text: prompt || `Tu es Julien, expert FAP/EGR/AdBlue depuis 20 ans chez Re-Fap. Analyse cette photo de tableau de bord automobile et r√©ponds COMME JULIEN :

üîç ANALYSE PR√âCISE :
1. Quels voyants sont allum√©s (couleur, forme, position) ?
2. Y a-t-il des messages d'erreur affich√©s ?
3. Peux-tu identifier la marque/mod√®le du v√©hicule ?
4. Si voyant FAP/moteur/antipollution : quel est ton diagnostic expert ?

üí¨ TON DE JULIEN :
- Direct, pr√©cis, professionnel mais humain
- "Je vois...", "Mon diagnostic...", "Ma recommandation..."
- Propose solution Re-Fap si probl√®me d√©pollution
- Sinon redirige vers diagnostic m√©canique g√©n√©ral
- Termine par une question pour continuer le diagnostic
- Reste dans ta sp√©cialit√© FAP/EGR/AdBlue

üéØ OBJECTIF : G√©n√©rer un lead qualifi√© pour Re-Fap`
            },
            {
                type: "image",
                source: {
                    type: "base64",
                    media_type: mediaType,
                    data: imageData
                }
            }
        ];

        // Appel √† Claude Vision API
        const claudeResponse = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'x-api-key': CLAUDE_API_KEY,
                'Content-Type': 'application/json',
                'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
                model: "claude-3-5-sonnet-20241022",
                max_tokens: 500,
                messages: [{
                    role: "user",
                    content: messageContent
                }]
            })
        });

        if (!claudeResponse.ok) {
            const errorData = await claudeResponse.text();
            console.error('‚ùå Erreur Claude API:', claudeResponse.status, errorData);
            
            return response.status(500).json({
                error: `Erreur Claude API: ${claudeResponse.status}`,
                fallback: generateFallbackAnalysis(image),
                debug: process.env.NODE_ENV === 'development' ? errorData : undefined
            });
        }

        const claudeData = await claudeResponse.json();
        
        // Log pour debug (sans exposer la cl√© API)
        console.log('‚úÖ Analyse Claude r√©ussie:', {
            timestamp: new Date().toISOString(),
            tokensUsed: claudeData.usage?.input_tokens + claudeData.usage?.output_tokens,
            model: claudeData.model
        });

        // Retourner l'analyse
        return response.status(200).json({
            success: true,
            analysis: claudeData.content[0].text,
            metadata: {
                timestamp: new Date().toISOString(),
                model: 'claude-3-5-sonnet',
                tokensUsed: claudeData.usage?.input_tokens + claudeData.usage?.output_tokens
            }
        });

    } catch (error) {
        console.error('üí• Erreur serveur:', error);
        
        return response.status(500).json({
            error: 'Erreur interne du serveur',
            fallback: generateFallbackAnalysis(),
            debug: process.env.NODE_ENV === 'development' ? error.message : undefined
        });
    }
}

// Fonction de fallback intelligente
function generateFallbackAnalysis() {
    const responses = [
        `Salut ! Julien ici, expert FAP/EGR depuis 20 ans ! 

D√©cris-moi ton probl√®me auto : voyants allum√©s, fum√©es, codes erreur... 

Je vais te donner un diagnostic pr√©cis ! üîß`,

        `Hello ! C'est Julien, sp√©cialiste d√©pollution Re-Fap !

Explique-moi tes sympt√¥mes : perte puissance, surconsommation, fum√©es...

Mon expertise √† ton service ! üéØ`
    ];

    return responses[Math.floor(Math.random() * responses.length)];
}
